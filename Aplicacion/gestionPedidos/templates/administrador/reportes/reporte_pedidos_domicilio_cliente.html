{% extends 'administrador/plantilla.html' %}
{% load static %}
{% block contenido %}
<br>

<style>
    :root {
        --cafe-oscuro: #b4764f;
        --cafe-medio: #cd966c;
        --cafe-claro: #D7B999;
        --cafe-suave: #EEDDC6;
        --verde: #3E7A3F;
        --verde-profundo: #2E5F32;
        --blanco-calido: #F8F5F2;
        --gris-suave: #E2DED8;
        --texto-oscuro: #2B1A10;
        --cafe-profundo: #8A5A3C;
        --crema-suave: #FAF4EC;
    }

    html, body {
        background: linear-gradient(135deg,
                var(--crema-suave),
                var(--cafe-suave) 45%,
                var(--blanco-calido));
        overflow-x: hidden;
    }

    .main-content-wrapper {
        padding: 20px;
    }

    .content-card {
        background: var(--crema-suave);
        padding: 30px;
        border-radius: 15px;
        border: 1px solid var(--cafe-suave);
        box-shadow: 0 8px 18px rgba(0, 0, 0, .1);
        max-width: 1200px;
        margin: auto;
    }

    h2 {
        color: var(--cafe-profundo);
        font-weight: bold;
        text-shadow: 1px 1px 2px #fff;
    }

    .form-filtros {
        background: var(--blanco-calido);
        border: 1px solid var(--gris-suave);
        border-radius: 12px;
        padding: 20px;
    }

    .btn-filtrar {
        background: var(--verde-profundo);
        color: white;
        border-radius: 10px;
        padding: 8px 18px;
        font-weight: bold;
    }

    .btn-filtrar:hover {
        background: var(--verde);
    }

    .table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
    }

    .table thead {
        background: var(--cafe-medio);
        color: white;
    }

    .table tbody tr:hover {
        background: #f6efe7;
    }

    .total-box {
        background: var(--blanco-calido);
        border-left: 6px solid var(--verde-profundo);
        padding: 12px 18px;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: bold;
    }

    .btn-regresar {
        background: var(--cafe-profundo);
        color: white;
        border-radius: 10px;
        padding: 8px 18px;
        font-weight: bold;
        border: none;
    }

    .btn-regresar:hover {
        background: var(--cafe-oscuro);
        color: white;
    }
</style>

<div class="main-content-wrapper">
    <div class="content-card">

        <h2 class="text-center mb-4">
            Reporte de Pedidos - Cliente Domicilio
        </h2>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{% url 'reportes_general' %}" class="btn btn-regresar">
                Regresar
            </a>
        </div>

        <br><br>

        <!-- ================= FILTROS ================= -->
        <form method="GET" class="row g-3 form-filtros mb-4">

            <div class="col-md-2">
                <label class="fw-semibold">Código</label>
                <input type="text" name="codigo" class="form-control"
                       value="{{ request.GET.codigo }}">
            </div>

            <div class="col-md-2">
                <label class="fw-semibold">Fecha inicio</label>
                <input type="date" name="fecha_inicio" class="form-control"
                       value="{{ request.GET.fecha_inicio }}">
            </div>

            <div class="col-md-2">
                <label class="fw-semibold">Fecha fin</label>
                <input type="date" name="fecha_fin" class="form-control"
                       value="{{ request.GET.fecha_fin }}">
            </div>

            <div class="col-md-3">
                <label class="fw-semibold">Estado</label>
                <select name="estado" class="form-select">
                    <option value="">Todos</option>
                    {% for value,label in pedidos.model.ESTADOS %}
                        <option value="{{ value }}"
                            {% if request.GET.estado == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="fw-semibold">Cajero</label>
                <select name="cajero" class="form-select">
                    <option value="">Todos</option>
                    {% for c in cajeros %}
                        <option value="{{ c.id }}"
                            {% if request.GET.cajero == c.id|stringformat:"s" %}selected{% endif %}>
                            {{ c.nombre }} {{ c.apellido }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12 text-end">
                <button class="btn btn-filtrar mt-2">
                    Filtrar
                </button>
            </div>
        </form>

        <!-- ================= EXPORTAR ================= -->
        <a href="{% url 'exportar_pedidos_cliente_pdf' %}?{{ request.GET.urlencode }}"
           class="btn btn-danger">
            Exportar PDF
        </a>

        <br><br>

        <a href="{% url 'exportar_pedidos_cliente_excel' %}?{{ request.GET.urlencode }}"
           class="btn btn-success">
            Exportar Excel
        </a>

        <br><br>

        <!-- ================= TOTAL ================= -->
        <div class="d-flex justify-content-end mb-3">
            <div class="total-box">
                Total general: ${{ total_general }}
            </div>
        </div>

        <!-- ================= TABLA ================= -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="text-center">
                    <tr>
                        <th>Código</th>
                        <th>Cajero</th>
                        <th>Cliente</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Comprobante Cliente</th>
                        <th>Comprobante Sistema</th>
                        <th>Fecha</th>
                    </tr>
                </thead>

                <tbody>
                    {% for pedido in pedidos %}
                    <tr>
                        <td class="text-center">{{ pedido.codigo_pedido }}</td>
                        <td>{{ pedido.cajero.nombre|default:"—" }}</td>
                        <td>{{ pedido.cliente.nombre }} {{ pedido.cliente.apellido }}</td>
                        <td class="text-success fw-bold">${{ pedido.total }}</td>
                        <td>{{ pedido.get_estado_display }}</td>

                        <td class="text-center">
                            {% with pedido.comprobantes_cliente.first as comp %}
                                {% if comp %}
                                    <a href="{{ comp.imagen.url }}" target="_blank"
                                       class="btn btn-sm btn-primary">
                                        Ver
                                    </a>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            {% endwith %}
                        </td>

                        <td class="text-center">
                            {% with pedido.pagos.first as pago %}
                                {% if pago and pago.comprobante_set.first %}
                                    <a href="{{ pago.comprobante_set.first.archivo_pdf.url }}"
                                       target="_blank"
                                       class="btn btn-sm btn-danger">
                                        PDF
                                    </a>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            {% endwith %}
                        </td>

                        <td>{{ pedido.fecha_hora|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-3">
                            No hay pedidos registrados
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<br>
{% endblock %}
