{% extends 'administrador/plantilla.html' %}
{% load static %}

{% block contenido %}

<br><br><br>

<div class="container mt-4">

    <!-- ======================================================= -->
    <!--        SECCIÓN 1: PEDIDOS DEL RESTAURANTE              -->
    <!-- ======================================================= -->
    <h2 class="text-center text-primary mb-4">
        Pedidos del restaurante (Meseros)
    </h2>

    <div id="pedidos-restaurante" class="row g-4">
        {% for pedido in pedidos_restaurante %}
        <div class="col-md-4" id="pedido-{{ pedido.id }}">
            <div class="pedido-card card p-3 shadow-sm">
                <h4>Pedido #{{ pedido.id }} — Mesa {{ pedido.mesa.numero }}</h4>
                <p>Mesero: <strong>{{ pedido.mesero.nombre }}</strong></p>

                <ul>
                    {% for d in pedido.detalles.all %}
                    <li>
                        <strong>{{ d.cantidad }}x</strong> {{ d.producto.nombre }}<br>
                        <small>{{ d.observacion|default:"Sin observación" }}</small>
                    </li>
                    {% endfor %}
                </ul>

                <button class="btn btn-success btn-marcar-listo"
                        data-pedido-id="{{ pedido.id }}">
                    Listo
                </button>
            </div>
        </div>
        {% endfor %}
    </div>


    <hr class="my-5">


    <!-- ======================================================= -->
    <!--        SECCIÓN 2: PEDIDOS A DOMICILIO                  -->
    <!-- ======================================================= -->
    <h2 class="text-center text-success mb-4">
        Pedidos a domicilio (Cajeros)
    </h2>

    <div id="pedidos-domicilio" class="row g-4">
        {% for pedido in pedidos_domicilio %}
        <div class="col-md-4" id="pedido-{{ pedido.id }}">
            <div class="pedido-card card p-3 shadow-sm">
                <h4>Pedido #{{ pedido.id }} — Domicilio</h4>
                <p>Cajero: <strong>{{ pedido.cajero.nombre }}</strong></p>

                <ul>
                    {% for d in pedido.detalles.all %}
                    <li>
                        <strong>{{ d.cantidad }}x</strong> {{ d.producto.nombre }}<br>
                        <small>{{ d.observacion|default:"Sin observación" }}</small>
                    </li>
                    {% endfor %}
                </ul>

                <button class="btn btn-success btn-marcar-listo"
                        data-pedido-id="{{ pedido.id }}">
                    Listo
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

</div>


<!-- ======================================================= -->
<!--                     BOTÓN FLOTANTE                      -->
<!-- ======================================================= -->
<button id="btnAbrirMensaje" class="btn-flotante">
    <i class="fas fa-comments"></i>
</button>

<!-- ======================================================= -->
<!--                 FORMULARIO FLOTANTE                     -->
<!-- ======================================================= -->
<div id="formMensaje" class="form-flotante oculto">
    <div class="form-contenido">
        <h4 class="mb-3">Enviar mensaje</h4>

        <label class="form-label">Enviar a:</label>
        <select id="destinoTipo" class="form-control mb-3">
            <option value="mesero">Mesero</option>
            <option value="cajero">Cajero</option>
        </select>

        <label class="form-label">Seleccione destinatario:</label>
        <select id="destinoUsuario" class="form-control mb-3"></select>

        <label class="form-label">Mensaje:</label>
        <textarea id="mensajeTexto" class="form-control mb-3" rows="3"></textarea>

        <div class="text-end">
            <button class="btn btn-secondary" id="btnCerrarMensaje">Cancelar</button>
            <button class="btn btn-primary" id="btnEnviarMensaje">Enviar</button>
        </div>
    </div>
</div>

<!-- SELECTS OCULTOS SOLO PARA CARGAR OPCIONES -->
<select id="meserosHidden" class="d-none">
    {% for m in meseros %}
        <option value="{{ m.id }}">{{ m.nombre }} {{ m.apellido }}</option>
    {% endfor %}
</select>

<select id="cajerosHidden" class="d-none">
    {% for c in cajeros %}
        <option value="{{ c.id }}">{{ c.nombre }} {{ c.apellido }}</option>
    {% endfor %}
</select>




<!-- ======================================================= -->
<!--                        ESTILOS                          -->
<!-- ======================================================= -->
<style>
    .pedido-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        padding: 20px;
        border-left: 5px solid #007bff;
        transition: all .3s ease;
    }
    .pedido-card:hover { transform: translateY(-5px); }

    /* Botón flotante */
    .btn-flotante {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: #0d6efd;
        color: white;
        width: 65px;
        height: 65px;
        border-radius: 50%;
        font-size: 30px;
        border: none;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 4px 10px rgba(0,0,0,.3);
    }

    /* Formulario flotante */
    .form-flotante {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 350px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,.3);
        z-index: 999;
        transition: .3s;
    }
    .form-flotante.oculto {
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
    }

    /* Animación desaparecer */
    .pedido-fade-out {
        animation: desaparecer .5s ease forwards;
    }
    @keyframes desaparecer {
        from { opacity: 1; }
        to   { opacity: 0; transform: translateY(-20px); height: 0; padding: 0; margin: 0; }
    }
</style>


<meta name="csrf-token" content="{{ csrf_token }}">


<!-- ======================================================= -->
<!--                    JAVASCRIPT COMPLETO                  -->
<!-- ======================================================= -->
<script>

    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').content;
    }

    // ---------------------------------------------------
    // WEBSOCKET → NUEVOS PEDIDOS EN TIEMPO REAL
    // ---------------------------------------------------
    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const socket = new WebSocket(protocol + window.location.host + "/ws/pedidos/");

    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        // NUEVO PEDIDO
        if (data.type === "nuevo_pedido") {

            const html = generarCard(data.pedido);

            // Si tiene mesa → restaurante
            let contenedor =
                data.pedido.mesa ?
                document.getElementById("pedidos-restaurante") :
                document.getElementById("pedidos-domicilio");

            contenedor.insertAdjacentHTML("afterbegin", html);
        }

        if (data.type === "actualizar_pedido") {

            let id = data.pedido.id;

            // BORRAR TARJETA ANTERIOR
            document.querySelector(`#pedido-${id}`)?.remove();

            // DETERMINAR CONTENEDOR SEGÚN TIPO DE PEDIDO
            let contenedor;

            if (data.pedido.tipo === "domicilio") {
                contenedor = document.getElementById("pedidos-domicilio");
            } else {
                contenedor = document.getElementById("pedidos-restaurante");
            }

            // INSERCIÓN
            contenedor.insertAdjacentHTML("afterbegin", generarCard(data.pedido));
        }


        // ELIMINAR
        if (data.type === "eliminar_pedido") {
            let btn = document.querySelector(`[data-pedido-id="${data.pedido_id}"]`);
            let card = btn?.closest(".pedido-card");

            if (card) {
                card.classList.add("pedido-fade-out");
                setTimeout(() => card.parentElement.remove(), 500);
            }
        }
    };

    // Generar tarjeta
    function generarCard(p) {
        return `
            <div class="col-md-4" id="pedido-${p.id}">
                <div class="pedido-card card p-3 shadow-sm">
                    <h4>Pedido #${p.id} — ${p.mesa ? "Mesa " + p.mesa : "Domicilio"}</h4>
                    <ul>
                        ${p.productos.map(x => `
                            <li><strong>${x.cantidad}x</strong> ${x.nombre}
                            <br><small>${x.observacion || "Sin observación"}</small></li>
                        `).join("")}
                    </ul>
                    <button class="btn btn-success btn-marcar-listo"
                        data-pedido-id="${p.id}">Listo</button>
                </div>
            </div>`;
    }


    // ---------------------------------------------------
    // MARCAR PEDIDO COMO LISTO
    // ---------------------------------------------------
    document.addEventListener("click", function(e) {
        if (!e.target.classList.contains("btn-marcar-listo")) return;

        let btn = e.target;
        let pedidoId = btn.dataset.pedidoId;

        btn.disabled = true;
        btn.innerText = "Procesando...";

        fetch(`/pedido/${pedidoId}/listo/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                btn.innerText = "Listo ✔️";
                btn.classList.replace("btn-success", "btn-secondary");

                let card = btn.closest(".pedido-card");
                card.classList.add("pedido-fade-out");
                setTimeout(() => card.parentElement.remove(), 500);

            } else {
                btn.disabled = false;
                btn.innerText = "Error";
            }
        });
    });

    // ---------------------------------------------------
    // FORMULARIO DE MENSAJES (SE MANTIENE)
    // ---------------------------------------------------
    const btnAbrirMensaje = document.getElementById("btnAbrirMensaje");
    const formMensaje = document.getElementById("formMensaje");
    const btnCerrarMensaje = document.getElementById("btnCerrarMensaje");
    const btnEnviarMensaje = document.getElementById("btnEnviarMensaje");

    btnAbrirMensaje.onclick = () => formMensaje.classList.remove("oculto");
    btnCerrarMensaje.onclick = () => formMensaje.classList.add("oculto");

    btnEnviarMensaje.onclick = () => {
        const tipo = document.getElementById("destinoTipo").value;
        const usuarioId = document.getElementById("destinoUsuario").value;
        const mensaje = document.getElementById("mensajeTexto").value.trim();

        if (!mensaje) {
            Swal.fire("Escribe un mensaje.", "", "warning");
            return;
        }

        fetch("/cocina/enviar-mensaje/", {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                tipo_destino: tipo,
                usuario_id: usuarioId,
                mensaje: mensaje
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                Swal.fire("Mensaje enviado", "", "success");
                document.getElementById("mensajeTexto").value = "";
                formMensaje.classList.add("oculto");
            }
        });
    };

    const selectTipo     = document.getElementById("destinoTipo");
    const selectUsuario  = document.getElementById("destinoUsuario");
    const meserosHidden  = document.getElementById("meserosHidden");
    const cajerosHidden  = document.getElementById("cajerosHidden");

    // carga inicial: meseros
    cargarDestinatarios("mesero");

    selectTipo.addEventListener("change", function () {
        cargarDestinatarios(this.value);
    });

    function cargarDestinatarios(tipo) {
        const source = (tipo === "mesero") ? meserosHidden : cajerosHidden;
        // copiamos las opciones del select oculto al visible
        selectUsuario.innerHTML = source.innerHTML;
    }


</script>

{% endblock %}
