{% extends 'cocinero/plantilla.html' %}
{% load static %}

{% block contenido %}

<style>
    :root {
        --cafe-oscuro: #b4764f;
        --cafe-medio: #cd966c;
        --cafe-claro: #D7B999;
        --cafe-suave: #EEDDC6;

        --verde: #3E7A3F;
        --verde-claro: #7FBF6A;

        --blanco-calido: #F8F5F2;
        --gris-suave: #E2DED8;
        --texto-oscuro: #2B1A10;

        --rojo-alerta: #C14949;
        --rojo-oscuro: #8C2F39;
        --rojo-claro: #EA9A9A;

        --cafe-profundo: #8A5A3C;
        --cafe-tostado: #A66E4A;
        --cafe-avellana: #C8A784;
        --cafe-crema: #F0E1CA;

        --verde-profundo: #2E5F32;

        --crema-suave: #FAF4EC;
        --gris-oscuro-calido: #4A3F38;

        --azul-pizarra: #4F6D7A;

        --info-suave: #DDE9F2;
        --advertencia: #D9A441;
        --advertencia-suave: #FFF5DA;
    }

    html, body {
        height: 100%;
        margin: 0;
        overflow-x: hidden;
        background: linear-gradient(135deg,
                var(--crema-suave),
                var(--cafe-suave) 45%,
                var(--blanco-calido));
        color: var(--texto-oscuro);
        font-family: 'Segoe UI', sans-serif;
    }

    .main-content-wrapper {
        padding-left: 15px;
        padding-right: 15px;
    }

    @media (min-width: 768px) {
        .main-content-wrapper { padding-left: 40px; padding-right: 40px; }
    }

    @media (min-width: 1200px) {
        .main-content-wrapper { padding-left: 80px; padding-right: 80px; }
    }

    .content-card {
        background: var(--blanco-calido);
        padding: 25px 28px;
        border-radius: 18px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.10);
        border: 1px solid var(--cafe-suave);
        margin-bottom: 30px;
    }

    .content-card h2 {
        color: var(--cafe-profundo);
        font-weight: 800;
        text-align: center;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px #ffffff80;
    }

    .pedidos-lista {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .pedido-card {
        width: 100%;
        background: var(--blanco-calido);
        border-radius: 18px;
        border: 1px solid var(--gris-suave);
        border-left: 7px solid #B8B1A8;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.10);
        padding: 14px 14px 12px 14px;
        transition: all 0.2s ease;
        position: relative;
        padding-top: 14px;
    }

    .pedido-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
        border-color: var(--cafe-medio);
        background: var(--crema-suave);
    }

    .pedido-card.estado-nuevo {
        border-left-color: var(--verde-profundo);
        box-shadow: 0 8px 18px rgba(46, 95, 50, 0.14);
    }

    .pedido-card.estado-preparacion {
        border-left-color: var(--advertencia);
        box-shadow: 0 8px 18px rgba(217, 164, 65, 0.18);
    }

    .badge-estado{
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 900;
        background: var(--advertencia-suave);
        color: #7A4F00;
        border: 1px solid var(--advertencia);
        white-space: nowrap;
    }

    .pedido-header{
        display: flex;
        justify-content: flex-start;
        margin-bottom: 14px;
    }



    /* ===============================
       FILA ÚNICA: encabezado + productos (MISMA LÍNEA)
    ================================ */
    .pedido-topline{
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--gris-suave);
        padding-top: 2px;
    }

    .pedido-meta{
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        min-width: 320px;
    }

    .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
    }

    .pill-codigo { background: var(--cafe-profundo); }
    .pill-tipo { background: var(--azul-pizarra); }
    .pill-mesa { background: var(--verde-profundo); }

    /* Productos pegados al header */
    .pedido-productos-inline{
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 18px; /* antes 14px (mejor lectura) */
        min-width: 280px;
    }

    .prod-inline{
        display: inline-flex;
        align-items: baseline;
        gap: 12px; /* antes 10px */
        white-space: nowrap;
    }

    /* ===============================
       MEJOR VISUALIZACIÓN COCINA
       - Productos más grandes (para verse lejos)
    ================================ */
    .qty{
        font-size: 1.15rem;
        font-weight: 900;
        color: var(--cafe-profundo);
        min-width: 30px;
        text-align: right;
    }

    .nombre{
        font-size: 1.15rem;
        font-weight: 900;
        color: var(--texto-oscuro);
    }

    .obs{
        font-size: 1.10rem;
        font-weight: 700;
        color: var(--gris-oscuro-calido);
    }

    /* En móvil: si no cabe, que baje */
    @media (max-width: 768px){
        .pedido-topline{
            flex-direction: column;
            align-items: flex-start;
        }
        .pedido-meta{
            min-width: auto;
        }
        .pedido-productos-inline{
            width: 100%;
        }
        .prod-inline{
            white-space: normal;
        }
    }

    /* ===============================
       Botones más pequeños
    ================================ */
    .btn-marcar-listo.btn-success {
        background-color: var(--verde-profundo) !important;
        border-color: var(--verde-profundo) !important;
        padding: 6px 12px;     /* antes 8px 16px */
        border-radius: 9px;    /* antes 10px */
        font-weight: 700;
        font-size: 1.2rem;
        transition: 0.2s;
    }

    .btn-marcar-listo.btn-success:hover {
        background-color: var(--verde) !important;
    }

    .btn-preparacion.btn-warning {
        background-color: var(--advertencia) !important;
        border-color: var(--advertencia) !important;
        color: #fff !important;
        padding: 6px 12px;     /* antes 8px 14px */
        border-radius: 9px;
        font-weight: 800;
        font-size: 1.2rem;
        transition: .2s;
    }

    .btn-preparacion.btn-warning:hover {
        filter: brightness(0.95);
    }

    /* reduce el espacio del contenedor de botones */
    .pedido-card .mt-3{
        margin-top: 10px !important;
    }

    /* En pantallas grandes (TV/monitor lejos) aumenta un poquito más */
    @media (min-width: 992px){
        .qty{ font-size: 1.25rem; }
        .nombre{ font-size: 1.25rem; }
        .obs{ font-size: 1.18rem; }
    }

    /* Botón flotante */
    .btn-flotante {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: var(--cafe-profundo);
        color: white;
        width: 65px;
        height: 65px;
        border-radius: 50%;
        font-size: 30px;
        border: none;
        cursor: pointer;
        z-index: 999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, .35);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
    }

    .btn-flotante:hover {
        background: var(--cafe-oscuro);
        transform: translateY(-3px);
    }


    .pedido-fade-out {
        animation: desaparecer .5s ease forwards;
    }

    @keyframes desaparecer {
        from { opacity: 1; }
        to {
            opacity: 0;
            transform: translateY(-20px);
            height: 0;
            padding: 0;
            margin: 0;
        }
    }

    /* ===============================
       PRODUCTOS ORDENADOS (CHIPS)
       - Cada producto queda en UNA sola línea
       - Se acomodan en filas sin desorden
       - No se parte qty/nombre/obs
    =============================== */

    .pedido-productos-inline{
        display: flex !important;
        flex-wrap: wrap;
        gap: 10px 16px;
        justify-content: flex-start;
        align-items: center;
        min-width: 0;
    }

    .prod-inline{
        display: inline-flex !important;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
        padding: 6px 10px;
        border-radius: 12px;
        background: rgba(240,225,202,.55);
        border: 1px solid rgba(166,110,74,.20);
    }

    /* cantidad más visible y alineada */
    .qty{
        font-size: 1.18rem;
        font-weight: 900;
        color: var(--cafe-profundo);
        min-width: 36px;
        text-align: right;
    }

    .nombre{
        font-size: 1.18rem;
        font-weight: 900;
        color: var(--texto-oscuro);
    }

    .obs{
        font-size: 1.10rem;
        font-weight: 700;
        color: var(--gris-oscuro-calido);
    }

    @media (min-width: 992px){
        .qty{ font-size: 1.28rem; }
        .nombre{ font-size: 1.28rem; }
        .obs{ font-size: 1.18rem; }
    }

    @media (max-width: 768px){
        .prod-inline{ white-space: normal; }
    }

    /* ==========================================================
       AGREGADO: MÁS ANCHO + PILLS MÁS GRANDES (SIN CAMBIAR LO DEMÁS)
       (Esto VA AL FINAL para sobrescribir lo anterior)
    ========================================================== */

    /* MÁS ANCHO ÚTIL: quita límite del .container de Bootstrap */
    .main-content-wrapper .container{
        max-width: 1800px !important;
    }
    @media (min-width: 1400px){
        .main-content-wrapper .container{
            max-width: 98vw !important;
        }
    }

    /* Card grande: reduce padding lateral para ganar espacio */
    .content-card{
        width: 100%;
        padding-left: 18px;
        padding-right: 18px;
    }
    @media (min-width: 1200px){
        .content-card{
            padding-left: 14px;
            padding-right: 14px;
        }
    }

    /* Al quitar mesero/cajero, compacta meta */
    .pedido-meta{
        min-width: auto !important;
        flex: 0 0 auto;
    }

    /* Pills más grandes (Código / Domicilio / Mesa) */
    .pill{
        font-size: 1.05rem;
        padding: 7px 14px;
        font-weight: 900;
        letter-spacing: .2px;
    }

    /* Badge “En preparación” más grande */
    .badge-estado{
        font-size: 0.95rem;
        padding: 6px 12px;
        font-weight: 900;
    }

    /* Chips un poco más compactos para que entren MÁS por línea */
    .prod-inline{
        padding: 5px 8px;
        gap: 8px;
    }
    .pedido-productos-inline{
        gap: 8px 12px;
    }

    /* Un poquito menos separación meta-productos */
    .pedido-topline{
        gap: 10px;
    }
</style>


<div class="main-content-wrapper">
    <div class="container mt-4">

        <div class="content-card">

            <div id="pedidos-cocina" class="pedidos-lista">

                {% for pedido in pedidos_restaurante %}
                <div id="pedido-{{ pedido.id }}" data-pedido-id="{{ pedido.id }}">
                    <div class="pedido-card
                        {% if pedido.estado == 'en preparacion' %}estado-preparacion{% else %}estado-nuevo{% endif %}">

                        {% if pedido.estado != 'en preparacion' %}
                            <div class="pedido-header">
                                <span class="badge-estado">En preparación</span>
                            </div>
                        {% endif %}

                        <div class="pedido-topline">
                            <div class="pedido-meta">
                                <span class="pill pill-codigo">Código: {{ pedido.codigo_pedido }}</span>
                                <span class="pill pill-mesa">Mesa {{ pedido.mesa.numero }}</span>
                            </div>

                            <div class="pedido-productos-inline">
                                {% for d in pedido.detalles.all %}
                                <span class="prod-inline">
                                    <span class="qty">{{ d.cantidad }}x</span>
                                    <span class="nombre">{{ d.producto.nombre }}</span>
                                    <span class="obs">- {{ d.observacion|default:"Sin observación" }}</span>
                                </span>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            {% if pedido.estado != 'en preparacion' %}
                            <button class="btn btn-warning btn-preparacion btn-marcar-preparacion"
                                    data-pedido-id="{{ pedido.id }}">
                                En preparación
                            </button>
                            {% endif %}

                            <button class="btn btn-success btn-marcar-listo" data-pedido-id="{{ pedido.id }}">
                                Listo
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}


                {% for pedido in pedidos_domicilio %}
                <div id="pedido-{{ pedido.id }}">
                    <div class="pedido-card
                        {% if pedido.estado == 'EN_PREPARACION' %}estado-preparacion{% else %}estado-nuevo{% endif %}">

                        {% if pedido.estado == 'EN_PREPARACION' %}
                            <span class="badge-estado">En preparación</span>
                        {% endif %}

                        <div class="pedido-topline">
                            <div class="pedido-meta">
                                <span class="pill pill-codigo">Código: {{ pedido.codigo_pedido }}</span>
                                <span class="pill pill-tipo">Domicilio</span>
                            </div>

                            <div class="pedido-productos-inline">
                                {% for d in pedido.detalles.all %}
                                <span class="prod-inline">
                                    <span class="qty">{{ d.cantidad }}x</span>
                                    <span class="nombre">{{ d.producto.nombre }}</span>
                                    <span class="obs">- {{ d.observacion|default:"Sin observación" }}</span>
                                </span>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            {% if pedido.estado != 'EN_PREPARACION' %}
                            <button class="btn btn-warning btn-preparacion btn-marcar-preparacion"
                                    data-pedido-id="{{ pedido.id }}">
                                En preparación
                            </button>
                            {% endif %}

                            <button class="btn btn-success btn-marcar-listo" data-pedido-id="{{ pedido.id }}">
                                Listo
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}

            </div>
        </div>

    </div>
</div>

<button id="btnAbrirMensaje" class="btn-flotante" type="button">
    <i class="fas fa-comments"></i>
</button>


<div class="modal fade" id="modalNoHay" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content" style="border-radius: 16px; border: 1px solid var(--cafe-avellana);">
      <div class="modal-header" style="background: var(--cafe-crema);">
        <h5 class="modal-title" style="font-weight: 900; color: var(--cafe-profundo);">
          Reportar producto
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body" style="background: var(--blanco-calido);">
        <div class="mb-3">
          <input id="buscarProducto" type="text" class="form-control"
                 placeholder="Buscar producto..."
                 style="border-radius: 12px;">
        </div>

        <div class="list-group" id="listaProductosNoHay">
          {% for p in productos_menu %}
            <div class="list-group-item d-flex align-items-center justify-content-between"
                 style="border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--gris-suave);">

              <div class="me-3" style="min-width: 0;">
                <div class="prod-nombre" style="font-weight: 900; font-size: 1.05rem; color: var(--texto-oscuro); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  {{ p.nombre }}
                </div>
                <div style="font-size: .92rem; color: var(--gris-oscuro-calido); font-weight: 700;">
                  Presiona NO para avisar que se agotó
                </div>
              </div>

              {% if p.agotado_hoy %}
                <button class="btn btn-sm"
                        type="button"
                        disabled
                        style="background: #6c757d; border-color: #6c757d; color: #fff; font-weight: 900; border-radius: 10px; min-width: 90px; cursor:not-allowed; opacity:.9;">
                    Enviado
                </button>
                {% else %}
                <button class="btn btn-sm btn-nohay"
                        type="button"
                        data-producto-id="{{ p.id }}"
                        data-producto-nombre="{{ p.nombre|escapejs }}"
                        style="background: var(--rojo-alerta); border-color: var(--rojo-alerta); color: #fff; font-weight: 900; border-radius: 10px; min-width: 70px;">
                    NO
                </button>
                {% endif %}

            </div>
          {% empty %}
            <div class="alert alert-warning" style="border-radius: 12px;">
              No hay productos en el menú.
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="modal-footer" style="background: var(--crema-suave);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                style="background: var(--gris-oscuro-calido); border-color: var(--gris-oscuro-calido); border-radius: 10px; font-weight: 800;">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>


<meta name="csrf-token" content="{{ csrf_token }}">

<script>
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').content;
    }

    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const socket = new WebSocket(protocol + window.location.host + "/ws/pedidos/");

    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === "nuevo_pedido") {
            const html = generarCard(data.pedido);
            insertarPedidoOrdenado(html, data.pedido.id);
        }


        if (data.type === "actualizar_pedido") {
        const p = data.pedido;

        const estadoNorm = (p.estado || "").toString().toLowerCase();

        // estados que YA NO deben verse en cocina
        if (estadoNorm === "listo" || estadoNorm === "finalizado") {
            const wrap = document.getElementById(`pedido-${p.id}`);
            if (wrap) {
                const card = wrap.querySelector(".pedido-card");
                if (card) {
                    card.classList.add("pedido-fade-out");
                    setTimeout(() => wrap.remove(), 500);
                } else {
                    wrap.remove();
                }
            }
            return; // importante: NO re-render
        }

        // si sigue activo, se actualiza normal
        const viejo = document.getElementById(`pedido-${p.id}`);
        if (viejo) viejo.remove();

        const html = generarCard(p);
        insertarPedidoOrdenado(html, p.id);
    }


        if (data.type === "eliminar_pedido") {
            const wrap = document.getElementById(`pedido-${data.pedido_id}`);
            if (wrap) {
                const card = wrap.querySelector(".pedido-card");
                if (card) {
                    card.classList.add("pedido-fade-out");
                    setTimeout(() => wrap.remove(), 500);
                } else {
                    wrap.remove();
                }
            }
        }
    };

    // ===============================
    // INSERTAR EN ORDEN ASC (viejo arriba)
    // ===============================
    function insertarPedidoOrdenado(html, pedidoId) {
        const contenedor = document.getElementById("pedidos-cocina");

        const temp = document.createElement("div");
        temp.innerHTML = html.trim();
        const nuevo = temp.firstElementChild;

        if (!nuevo) return;

        // guarda el id en el wrapper
        nuevo.setAttribute("data-pedido-id", pedidoId);

        const items = Array.from(contenedor.children);

        // inserta antes del primero que tenga id mayor
        const antesDe = items.find(el => {
            const idExistente = parseInt(el.getAttribute("data-pedido-id") || "0", 10);
            return idExistente > pedidoId;
        });

        if (antesDe) contenedor.insertBefore(nuevo, antesDe);
        else contenedor.appendChild(nuevo);
    }


    function generarCard(p) {
        const esRestaurante = !!p.mesa;

        const pillLugar = esRestaurante
            ? `<span class="pill pill-mesa">Mesa ${p.mesa}</span>`
            : `<span class="pill pill-tipo">Domicilio</span>`;

        // Normaliza estado para soportar: "en preparacion", "EN_PREPARACION", "listo", "LISTO"
        const estadoNorm = (p.estado || "").toString().toLowerCase();

        const esPreparacion = (estadoNorm === "en preparacion" || estadoNorm === "en_preparacion");
        const esListo = (estadoNorm === "listo");

        const claseEstado = esPreparacion ? "estado-preparacion" : "estado-nuevo";
        const badgeEstado = esPreparacion ? `<span class="badge-estado">En preparación</span>` : ``;

        // Solo mostrar botón "En preparación" si NO está en preparación y NO está listo
        const btnPreparacion = (!esPreparacion && !esListo) ? `
            <button class="btn btn-warning btn-preparacion btn-marcar-preparacion" data-pedido-id="${p.id}">
                En preparación
            </button>
        ` : "";

        const productosHtml = (p.productos || []).map(x => {
            const obs = (x.observacion && x.observacion.trim()) ? x.observacion : "Sin observación";
            return `
                <span class="prod-inline">
                    <span class="qty">${x.cantidad}x</span>
                    <span class="nombre">${x.nombre}</span>
                    <span class="obs">- ${obs}</span>
                </span>
            `;
        }).join("");

        return `
            <div id="pedido-${p.id}" data-pedido-id="${p.id}">
                <div class="pedido-card ${claseEstado}">
                    ${badgeEstado}

                    <div class="pedido-topline">
                        <div class="pedido-meta">
                            <span class="pill pill-codigo">Código: ${p.codigo_pedido || p.id}</span>
                            ${pillLugar}
                        </div>

                        <div class="pedido-productos-inline">
                            ${productosHtml}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        ${btnPreparacion}
                        <button class="btn btn-success btn-marcar-listo" data-pedido-id="${p.id}">
                            Listo
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    document.addEventListener("click", function (e) {
        const btnListo = e.target.closest(".btn-marcar-listo");
        if (!btnListo) return;

        let btn = btnListo;
        let pedidoId = btn.dataset.pedidoId;

        btn.disabled = true;
        btn.innerText = "Procesando...";

        fetch(`/pedido/${pedidoId}/listo/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                btn.innerText = "Listo";
                btn.classList.replace("btn-success", "btn-secondary");

                let wrap = document.getElementById(`pedido-${pedidoId}`);
                const card = btn.closest(".pedido-card");
                if (card) {
                    card.classList.add("pedido-fade-out");
                    setTimeout(() => wrap && wrap.remove(), 500);
                } else {
                    wrap && wrap.remove();
                }

                Swal.fire({
                    icon: "success",
                    title: "Pedido listo",
                    text: "El pedido fue marcado como listo.",
                    timer: 1600,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });
            } else {
                btn.disabled = false;
                btn.innerText = "Listo";

                Swal.fire({
                    icon: "error",
                    title: "No se pudo actualizar",
                    text: data.mensaje || "Ocurrió un error al marcar el pedido como listo.",
                    background: "#FFF7F0",
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#C14949"
                });
            }
        })
        .catch(() => {
            btn.disabled = false;
            btn.innerText = "Listo";

            Swal.fire({
                icon: "error",
                title: "Error de conexión",
                text: "No se pudo contactar con el servidor.",
                background: "#FFF7F0",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949"
            });
        });
    });

    document.addEventListener("click", function (e) {
        const btnPrep = e.target.closest(".btn-marcar-preparacion");
        if (!btnPrep) return;

        const pedidoId = btnPrep.dataset.pedidoId;

        btnPrep.disabled = true;
        btnPrep.innerText = "Procesando...";

        fetch(`/pedido/${pedidoId}/preparacion/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "Content-Type": "application/json"
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const card = btnPrep.closest(".pedido-card");
                card.classList.remove("estado-nuevo");
                card.classList.add("estado-preparacion");

                let badge = card.querySelector(".badge-estado");
                if (!badge) {
                    badge = document.createElement("span");
                    badge.className = "badge-estado";
                    badge.textContent = "En preparación";
                    card.appendChild(badge);
                } else {
                    badge.textContent = "En preparación";
                }

                btnPrep.remove();

                Swal.fire({
                    icon: "success",
                    title: "Marcado en preparación",
                    text: "El pedido fue marcado como en preparación.",
                    timer: 1400,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });

            } else {
                btnPrep.disabled = false;
                btnPrep.innerText = "En preparación";

                Swal.fire({
                    icon: "info",
                    title: "Pedido en preparación",
                    text: data.mensaje || "Este pedido ya está siendo preparado.",
                    timer: 1600,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#D9A441"
                });

            }
        })
        .catch(() => {
            btnPrep.disabled = false;
            btnPrep.innerText = "En preparación";

            Swal.fire({
                icon: "error",
                title: "Error de conexión",
                text: "No se pudo contactar con el servidor.",
                background: "#FFF7F0",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949"
            });
        });
    });

    // ===============================
    // MODAL "NO HAY PRODUCTOS" (lista + buscar + enviar)
    // ===============================

    // Abrir modal desde el botón flotante
    const btnAbrirMensaje = document.getElementById("btnAbrirMensaje");
    btnAbrirMensaje.addEventListener("click", () => {
        const modalEl = document.getElementById("modalNoHay");
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        const buscador = document.getElementById("buscarProducto");
        if (buscador) buscador.value = "";
        filtrarProductos("");
    });

    // Filtro de búsqueda
    const buscarProducto = document.getElementById("buscarProducto");
    if (buscarProducto) {
        buscarProducto.addEventListener("input", function () {
            filtrarProductos(this.value);
        });
    }

    function filtrarProductos(texto) {
        const q = (texto || "").toLowerCase().trim();
        const items = document.querySelectorAll("#listaProductosNoHay .list-group-item");
        items.forEach(it => {
            const nombreEl = it.querySelector(".prod-nombre");
            const nombre = (nombreEl ? nombreEl.textContent : "").toLowerCase();
            it.style.display = nombre.includes(q) ? "" : "none";
        });
    }

    // Click en botón NO
    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-nohay");
        if (!btn) return;

        const productoId = btn.dataset.productoId;
        const productoNombre = btn.dataset.productoNombre;

        Swal.fire({
            icon: "warning",
            title: "Confirmar",
            text: `¿Enviar aviso de que no hay "${productoNombre}" a meseros y cajeros?`,
            showCancelButton: true,
            confirmButtonText: "Enviar",
            cancelButtonText: "Cancelar",
            confirmButtonColor: "#C14949",
            cancelButtonColor: "#4A3F38",
            background: "#FFF7F0"
        }).then((res) => {
            if (!res.isConfirmed) return;

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = "Enviando...";

            fetch("/cocina/no-hay-producto/", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ producto_id: productoId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: "success",
                        title: "Aviso enviado",
                        text: data.mensaje || "Se notificó a meseros y cajeros.",
                        timer: 1600,
                        showConfirmButton: false,
                        background: "#FFF7F0",
                        iconColor: "#3E7A3F"
                    });

                    btn.textContent = "Enviado";
                    btn.disabled = true;
                    btn.classList.remove("btn-nohay");
                    btn.style.background = "#6c757d";
                    btn.style.borderColor = "#6c757d";
                    btn.style.cursor = "not-allowed";
                    btn.style.opacity = ".9";


                } else {
                    btn.disabled = false;
                    btn.textContent = oldText;

                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: data.mensaje || "No se pudo enviar el aviso.",
                        background: "#FFF7F0",
                        confirmButtonText: "Aceptar",
                        confirmButtonColor: "#C14949"
                    });
                }
            })
            .catch(() => {
                btn.disabled = false;
                btn.textContent = oldText;

                Swal.fire({
                    icon: "error",
                    title: "Error de conexión",
                    text: "No se pudo contactar con el servidor.",
                    background: "#FFF7F0",
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#C14949"
                });
            });
        });
    });

</script>


{% endblock %}
