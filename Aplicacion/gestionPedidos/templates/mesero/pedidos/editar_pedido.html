{% extends 'administrador/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<div class="container mt-5" style="max-width: 800px;">
    <h2 class="text-center text-primary mb-4">Editar Pedido #{{ pedido.id }}</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Formulario para editar el pedido -->
    <form method="post" id="frm_editar_pedido">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Mesero:</label>
                <select name="mesero" class="form-select" required>
                    {% for m in meseros %}
                        <option value="{{ m.id }}" {% if pedido.mesero.id == m.id %}selected{% endif %}>
                            {{ m.nombre }} {{ m.apellido}}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Mesa:</label>
                <select name="mesa" class="form-select">
                    <option value="">Sin mesa (domicilio)</option>
                    {% for mesa in mesas %}
                        <option value="{{ mesa.id }}" {% if pedido.mesa.id == mesa.id %}selected{% endif %}>
                            Mesa {{ mesa.numero }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Estado:</label>
                <select name="estado" class="form-select">
                    <option value="en preparacion" {% if pedido.estado == 'en preparacion' %}selected{% endif %}>
                        En preparación
                    </option>
                    <option value="listo" {% if pedido.estado == 'listo' %}selected{% endif %}>Listo</option>
                    <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                </select>
            </div>
        </div>

    </form>

    <!-- Tabla de detalles -->
    <h4 class="mt-4">Detalles del pedido:</h4>
    <div id="tabla_detalles">
        {% include 'mesero/pedidos/tabla_detalles.html' %}
    </div>

    <!-- Agregar productos -->
    <h4 class="mt-4">Agregar productos:</h4>
        <div class="row g-3">
            {% for producto in productos %}
            <div class="col-lg-2 col-md-3 col-sm-4 col-6">
                <div class="card border-0 shadow-sm rounded-4 h-100" style="padding-bottom: 0 !important;">
                    <div class="ratio ratio-16x9">
                        {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" class="object-fit-cover w-100 h-100 rounded-top-4">
                        {% else %}
                            <img src="{% static 'img/sin_imagen.png' %}" class="object-fit-cover w-100 h-100 rounded-top-4">
                        {% endif %}
                    </div>

                    <div class="p-2 d-flex flex-column" style="padding-bottom: 0 !important;">
                        <h6 class="fw-bold text-center small mb-1">{{ producto.nombre }}</h6>
                        <p class="text-muted small text-center mb-2" style="font-size: 0.75rem;">
                            {{ producto.descripcion }}
                        </p>
                        <p class="fw-bold text-success text-center mb-2" style="font-size: 0.9rem;">
                            ${{ producto.precio }}
                        </p>

                        <div class="d-flex flex-column mb-2" style="margin-bottom: 0 !important;">
                            <input type="number"
                                min="1"
                                value="1"
                                id="cantidad_{{ producto.id }}"
                                class="form-control form-control-sm mb-2">

                            <input type="text"
                                placeholder="Observación"
                                id="obs_{{ producto.id }}"
                                class="form-control form-control-sm mb-2">
                        </div>

                        <button class="btn btn-primary btn-sm w-100"
                                style="margin-bottom: 0 !important;"
                                onclick="agregarProducto('{{ producto.id }}')">
                            Agregar
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
</div>

<div class="d-grid mt-3">
    <button type="button" class="btn btn-primary" onclick="guardarPedido()">
        Guardar cambios del pedido
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ----------------------------------------
// Guardar cambios del pedido
// ----------------------------------------
function guardarPedido() {
    const form = document.getElementById('frm_editar_pedido');
    const formData = new FormData(form);

    fetch("{% url 'editar_pedido' pedido.id %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        Swal.fire({
            icon: "success",
            title: "Pedido actualizado",
            text: data.mensaje || "Cambios guardados correctamente",
            timer: 1500,
            showConfirmButton: false,
        });

        setTimeout(() => window.location.href = "{% url 'listar_pedidos' %}", 1500);
    });
}


// ----------------------------------------
// Agregar detalle (producto)
// ----------------------------------------
function agregarProducto(id) {
    let cantidad = document.getElementById(`cantidad_${id}`).value;
    let observacion = document.getElementById(`obs_${id}`).value;

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            producto_id: id,
            cantidad: cantidad,
            observacion: observacion
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            document.getElementById('tabla_detalles').innerHTML = data.tabla;
            Swal.fire({
                icon: 'success',
                title: 'Producto agregado',
                text: data.mensaje,
                timer: 1000,
                showConfirmButton: false
            });

            // Limpiar la observación luego de agregar
            document.getElementById(`obs_${id}`).value = "";
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.mensaje
            });
        }
    });
}

// ------------------------------
// Editar detalle (productos)
// ------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual) {

    Swal.fire({
        title: "Editar detalle",
        html: `
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <label style="font-weight:500; font-size:0.9rem;">Cantidad</label>
                <input id="swal_cantidad" type="number" min="1" 
                       value="${cantidad_actual}" 
                       style="
                           padding: 10px; 
                           border-radius: 8px; 
                           border: 1px solid #ced4da; 
                           box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
                           font-size: 0.9rem;
                       ">

                <label style="font-weight:500; font-size:0.9rem;">Observación</label>
                <input id="swal_observacion" type="text" 
                       value="${observacion_actual || ''}" 
                       style="
                           padding: 10px; 
                           border-radius: 8px; 
                           border: 1px solid #ced4da; 
                           box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
                           font-size: 0.9rem;
                       ">
            </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: "Actualizar",
        cancelButtonText: "Cancelar",
        customClass: {
            confirmButton: 'btn btn-primary btn-sm px-4 me-2',
            cancelButton: 'btn btn-secondary btn-sm px-4 ms-2'
        },
        buttonsStyling: false,
        preConfirm: () => {
            return {
                cantidad: document.getElementById('swal_cantidad').value,
                observacion: document.getElementById('swal_observacion').value
            };
        }
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(result.value)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({
                    icon: 'success',
                    title: 'Detalle actualizado',
                    text: data.mensaje,
                    timer: 1400,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.mensaje
                });
            }
        });
    });
}



// ----------------------------------------
// Eliminar detalle
// ----------------------------------------
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        text: "Esta acción no se puede deshacer",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Producto eliminado",
                    text: data.mensaje,
                    timer: 1500,
                    showConfirmButton: false
                });

            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje
                });
            }
        });
    });
}
</script>


<br><br><br>
{% endblock %}