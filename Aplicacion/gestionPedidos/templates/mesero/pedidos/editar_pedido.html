{% extends 'mesero/plantilla.html' %}
{% load static %}
{% block contenido %}
<br>

<style>
:root{
    --cafe-oscuro:#b4764f;
    --cafe-medio:#cd966c;
    --cafe-claro:#D7B999;
    --cafe-suave:#EEDDC6;

    --verde:#3E7A3F;
    --verde-claro:#7FBF6A;

    --blanco-calido:#F8F5F2;
    --gris-suave:#E2DED8;
    --texto-oscuro:#2B1A10;

    --rojo-alerta:#C14949;
    --rojo-oscuro:#8C2F39;
    --rojo-claro:#EA9A9A;

    --cafe-profundo:#8A5A3C;
    --cafe-tostado:#A66E4A;
    --cafe-avellana:#C8A784;
    --cafe-crema:#F0E1CA;

    --exito:#4F8A57;
    --crema-suave:#FAF4EC;
}

/* Fondo */
html,body{
    background: linear-gradient(
        135deg,
        var(--crema-suave),
        var(--cafe-suave) 45%,
        var(--blanco-calido)
    );
}

/* Contenedor principal */
.wrapper-editar{
    max-width: 1100px;
    margin: auto;
    background: var(--blanco-calido);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 12px 28px rgba(0,0,0,.12);
}

/* Título */
.titulo-editar{
    text-align:center;
    font-weight:800;
    color:var(--cafe-oscuro);
    margin-bottom:25px;
}

/* ===== DATOS PEDIDO ===== */
.card-datos{
    border: 1px solid var(--cafe-avellana);
    background: var(--crema-suave);
    border-radius:18px;
    padding:14px 16px;
    box-shadow:0 6px 16px rgba(0,0,0,.08);
    margin-bottom:30px;
}

.card-datos h5{
    font-weight:700;
    color:var(--cafe-oscuro);
    margin-bottom:15px;
}

.grid-datos{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
}

.grid-datos label{
    font-weight:600;
    color:#5a4636;
}

.form-control, .form-select{
    border-radius:12px;
    border:1px solid var(--cafe-claro);
}

/* ===== PRODUCTOS ===== */
.titulo-seccion{
    text-align:center;
    font-weight:800;
    color:var(--cafe-oscuro);
    margin:40px 0 20px;
}

.grid-productos{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
}

.card-producto{
    background: var(--crema-suave);
    border-radius: 15px;
    border: 1px solid var(--cafe-avellana);
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    transition: 0.3s;
    display:flex;
    flex-direction:column;
    padding:14px;
}

.card-producto:hover{
    transform: translateY(-5px);
    box-shadow: 0 12px 22px rgba(0,0,0,0.15);
}

.card-producto h5{
    min-height: 42px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    text-align:center;
    color: var(--cafe-profundo);
}

.card-producto p{
    text-align:center;
    font-size:.85rem;
    line-height:1.4;
    color:#6b6b6b;
}

.card-producto p.text-muted{
    min-height:48px;
    max-height:48px;
    overflow:hidden;
    text-overflow:ellipsis;
}

.precio-producto{
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--exito);
    margin: 6px 0 10px;
    letter-spacing: 0.5px;
}

.card-producto .btn{
    margin-top:auto;
    border-radius:12px;
    font-weight:700;
}

/* ===== BOTONES ===== */
.btn-agregar{
    background:var(--verde);
    color:white;
}
.btn-agregar:hover{
    background:var(--verde-claro);
    color:var(--texto-oscuro);
}

.btn-final{
    background:var(--verde);
    color:white;
    font-weight:700;
    padding:14px 28px;
    border-radius:16px;
}
.btn-final:hover{
    background:var(--verde-claro);
    color:var(--texto-oscuro);
}

/* Responsive */
@media (max-width: 576px){
    .wrapper-editar{ padding: 16px; border-radius: 16px; }
}
.producto-agotado{
  opacity: .55;
  filter: grayscale(100%);
}

.producto-agotado .btn-agregar{
  cursor: not-allowed;
}

.producto-agotado .btn-agregar:disabled{
  opacity: 1; /* para que no se vea doblemente apagado */
}

/* ===============================
   SWEETALERT2 – ESTILO COMO IMAGEN
   =============================== */
.swal-cafe-popup{
    background: #FFF7F0 !important;
    border-radius: 16px !important;
    padding: 18px 20px 16px !important;
}

.swal-cafe-title{
    color: #4A3F38 !important;
    font-weight: 800 !important;
    font-size: 28px !important;
    margin-bottom: 10px !important;
}

.swal-cafe-html{
    margin: 0 !important;
    padding: 0 !important;
}

.swal-form-wrap{
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 6px;
}

.swal-form-wrap label{
    text-align: center;
    font-weight: 700;
    color: #4A3F38;
    margin: 0;
}

.swal-cafe-input{
    width: 100%;
    border-radius: 12px !important;
    border: 1px solid #D7B999 !important;
    background: #F8F5F2 !important;
    padding: 10px 12px !important;
    outline: none !important;
    box-shadow: none !important;
}

.swal-cafe-input:focus{
    border-color: #7FBF6A !important;
    box-shadow: 0 0 0 3px rgba(127, 191, 106, .25) !important;
}

.swal-cafe-actions{
    margin-top: 14px !important;
    gap: 14px !important;
}

.swal-cafe-confirm{
    background: #3E7A3F !important;
    color: #fff !important;
    border: none !important;
    border-radius: 8px !important;
    padding: 10px 18px !important;
    font-weight: 800 !important;
    min-width: 140px;
}

.swal-cafe-cancel{
    background: #C14949 !important;
    color: #fff !important;
    border: none !important;
    border-radius: 8px !important;
    padding: 10px 18px !important;
    font-weight: 800 !important;
    min-width: 140px;
}

/* Mensaje de validación */
.swal2-validation-message{
    background: #FFF5DA !important;
    color: #4A3F38 !important;
    border-radius: 10px !important;
    font-weight: 700 !important;
}


</style>

<div class="main-content-wrapper">
    <div class="wrapper-editar mt-5">

        <!-- TÍTULO -->
        <h2 class="titulo-editar">
            Editar Pedido Restaurante {{ pedido.codigo_pedido }}
        </h2>

        <!-- DATOS DEL PEDIDO -->
        <div class="card-datos">
            <h5>Datos del pedido</h5>

            <form method="post" id="frm_editar_pedido">
                {% csrf_token %}

                <div class="grid-datos">
                    <div>
                        <label>Mesa</label>
                        <select name="mesa" class="form-select" required>
                            {% for mesa in mesas %}
                                <option value="{{ mesa.id }}" {% if pedido.mesa.id == mesa.id %}selected{% endif %}>
                                    Mesa {{ mesa.numero }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label>Mesero</label>
                        <input class="form-control" value="{{ request.user.nombre }} {{ request.user.apellido }}" disabled>
                    </div>

                    <div>
                        <label>Estado</label>
                        <input class="form-control" value="{{ pedido.estado }}" disabled>
                    </div>
                </div>
            </form>
        </div>

        <!-- PRODUCTOS -->
        <h4 class="titulo-seccion">Agregar productos</h4>

        <div class="grid-productos">
            {% for producto in productos %}
            <div class="card-producto h-100 {% if producto.agotado_hoy %}producto-agotado{% endif %}"
                data-producto-id="{{ producto.id }}">

                <h5 class="fw-bold text-center mb-2">
                {{ producto.nombre }}
                {% if producto.agotado_hoy %}
                    <span class="badge bg-secondary ms-2">Agotado hoy</span>
                {% endif %}
                </h5>

                <p class="text-muted text-center small mb-2">{{ producto.descripcion }}</p>

                <p class="precio-producto text-center">${{ producto.precio }}</p>

                <label>Cantidad:</label>
                <input type="number" min="1" value="1"
                    id="cantidad_{{ producto.id }}"
                    class="form-control mt-2"
                    {% if producto.agotado_hoy %}disabled{% endif %}>

                <label>Observación:</label>
                <input type="text"
                    placeholder="Observación"
                    id="obs_{{ producto.id }}"
                    class="form-control mt-2"
                    {% if producto.agotado_hoy %}disabled{% endif %}>

                <button type="button"
                        class="btn btn-agregar mt-3 w-100"
                        data-producto-id="{{ producto.id }}"
                        {% if producto.agotado_hoy %}disabled{% endif %}
                        onclick="agregarProducto('{{ producto.id }}')">
                    Agregar
                </button>
            </div>
            {% endfor %}

        </div>

        <!-- TABLA -->
        <h4 class="titulo-seccion">Detalles del pedido</h4>
        <div id="tabla_detalles">
            {% include 'mesero/pedidos/tabla_detalles.html' %}
        </div>

        <!-- ACCIÓN FINAL -->
        <div class="text-center mt-4">
            <button form="frm_editar_pedido" class="btn btn-final">
                Guardar cambios y ver pedido
            </button>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// -------------------------------------------------------------
// Agregar producto (restaurante) + estilo Swal igual al cajero
// -------------------------------------------------------------
function agregarProducto(id) {

    const btn = document.querySelector(`button[data-producto-id="${id}"]`);
    if (btn && btn.disabled) {
    Swal.fire({
        icon: "warning",
        title: "Agotado hoy",
        text: "Este producto está agotado hoy y no se puede agregar.",
        confirmButtonText: "Aceptar",
        confirmButtonColor: "#3E7A3F",
        background: "#FFF7F0",
        iconColor: "#D9A441"
    });
    return;
    }

    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;

    if (isNaN(cantidad) || cantidad <= 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Cantidad inválida',
            text: 'Ingrese una cantidad mayor a 0',
            background: "#FFF7F0",
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#3E7A3F",
            iconColor: "#D9A441"
        });
        return;
    }

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            producto_id: id,
            cantidad: cantidad,
            observacion: observacion
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("tabla_detalles").innerHTML = data.tabla;

            Swal.fire({
                icon: "success",
                title: "Producto agregado",
                timer: 1200,
                background: "#FFF7F0",
                showConfirmButton: false,
                iconColor: "#3E7A3F",
                iconColor: "#3E7A3F"
            });

            document.getElementById(`obs_${id}`).value = "";
        } else {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.mensaje || "No se pudo agregar el producto.",
                background: "#FFF7F0",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949",
                iconColor: "#C14949",
            });
        }
    })
    .catch(() => {
        Swal.fire({
            icon: "error",
            title: "Error de conexión",
            text: "No se pudo contactar con el servidor.",
            background: "#FFF7F0",
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#C14949",
            iconColor: "#C14949",
        });
    });
}

// -------------------------------------------------------------
// Editar detalle (sin recargo) + estilo cajero
// -------------------------------------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual) {

    Swal.fire({
        title: "Editar detalle",
        html: `
            <div class="swal-form-wrap">
                <label>Cantidad</label>
                <input id="swal_cantidad"
                       type="number"
                       min="1"
                       value="${cantidad_actual}"
                       class="swal-cafe-input">

                <label>Observación</label>
                <input id="swal_observacion"
                       type="text"
                       value="${observacion_actual || ''}"
                       class="swal-cafe-input">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: "Actualizar",
        cancelButtonText: "Cancelar",

        // IMPORTANTE para que use tus estilos
        buttonsStyling: false,
        customClass: {
            popup: "swal-cafe-popup",
            title: "swal-cafe-title",
            htmlContainer: "swal-cafe-html",
            actions: "swal-cafe-actions",
            confirmButton: "swal-cafe-confirm",
            cancelButton: "swal-cafe-cancel",
        },

        preConfirm: () => {
            const cantidad = parseInt(document.getElementById("swal_cantidad").value);
            const observacion = document.getElementById("swal_observacion").value;

            if (isNaN(cantidad) || cantidad <= 0) {
                Swal.showValidationMessage("La cantidad debe ser mayor a 0");
                return false;
            }

            return { cantidad, observacion };
        }
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(result.value)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("tabla_detalles").innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Detalle actualizado",
                    text: data.mensaje || "",
                    timer: 1400,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje || "No se pudo actualizar el detalle.",
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#C14949",
                    background: "#FFF7F0",
                    iconColor: "#C14949"
                });
            }
        })
        .catch(() => {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Falló la petición (revisa Network/Console).",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949",
                background: "#FFF7F0",
                iconColor: "#C14949"
            });
        });
    });
}

// -------------------------------------------------------------
// Eliminar detalle + estilo cajero
// -------------------------------------------------------------
function eliminarDetalleAjax(detalle_id) {

    Swal.fire({
        title: "¿Eliminar producto?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Eliminar",
        cancelButtonText: "Cancelar",
        background: "#FFF7F0",
        confirmButtonColor: "#C14949",
        cancelButtonColor: "#4F6D7A",
        iconColor: "#D9A441"
    }).then(result => {
        if (!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("tabla_detalles").innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Eliminado",
                    timer: 1200,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje || "No se pudo eliminar.",
                    background: "#FFF7F0",
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#C14949",
                    iconColor: "#C14949",
                });
            }
        });
    });
}

// -------------------------------------------------------------
// Validar productos antes de guardar y ver pedido (igual cajero)
// -------------------------------------------------------------
function validarProductos() {
    const filas = document.querySelectorAll("#tabla_detalles tbody tr");
    if (filas.length === 1 && filas[0].textContent.includes("Aún no hay productos")) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin productos',
            text: 'Debe agregar al menos un producto antes de finalizar.',
            background: "#FFF7F0",
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#3E7A3F",
            iconColor: "#D9A441"
        });
        return false;
    }
    return true;
}

document.getElementById("frm_editar_pedido").addEventListener("submit", function(e) {
    e.preventDefault();

    if (!validarProductos()) return;

    let formData = new FormData(this);

    fetch("", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {

            Swal.fire({
                icon: "success",
                title: "Pedido actualizado correctamente",
                text: "Redirigiendo...",
                timer: 1500,
                showConfirmButton: false,
                background: "#FFF7F0",
                iconColor: "#3E7A3F"
            });

            setTimeout(() => {
                window.location.href = "{% url 'ver_pedido' 99999 %}".replace("99999", data.pedido_id);
            }, 1500);

        } else {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.mensaje || "Ocurrió un error.",
                background: "#FFF7F0",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949",
                iconColor: "#C14949",
            });
        }
    })
    .catch(() => {
        Swal.fire({
            icon: "error",
            title: "Error de conexión",
            text: "No se pudo actualizar el pedido.",
            background: "#FFF7F0",
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#C14949",
            iconColor: "#C14949",
        });
    });
});
</script>

<br>
{% endblock %}
