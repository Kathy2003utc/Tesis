{% extends 'administrador/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<div class="container mt-5" style="max-width: 800px;">
    <h2 class="text-center text-primary mb-4">Editar Pedido #{{ pedido.id }}</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Formulario para editar el pedido -->
    <form method="post" id="frm_editar_pedido">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Mesero:</label>
                <select name="mesero" class="form-select" required>
                    {% for m in meseros %}
                        <option value="{{ m.id }}" {% if pedido.mesero.id == m.id %}selected{% endif %}>
                            {{ m.nombre }} {{ m.apellido}}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Mesa:</label>
                <select name="mesa" class="form-select">
                    <option value="">Sin mesa (domicilio)</option>
                    {% for mesa in mesas %}
                        <option value="{{ mesa.id }}" {% if pedido.mesa.id == mesa.id %}selected{% endif %}>
                            Mesa {{ mesa.numero }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Estado:</label>
                <select name="estado" class="form-select">
                    <option value="en preparacion" {% if pedido.estado == 'en preparacion' %}selected{% endif %}>
                        En preparación
                    </option>
                    <option value="listo" {% if pedido.estado == 'listo' %}selected{% endif %}>Listo</option>
                    <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                </select>
            </div>
        </div>

    </form>

    <!-- Tabla de detalles -->
    <h4 class="mt-4">Detalles del pedido:</h4>
    <div id="tabla_detalles">
        {% include 'mesero/pedidos/tabla_detalles.html' %}
    </div>

    <!-- Agregar productos -->
    <h4 class="mt-4">Agregar productos:</h4>
    <div class="row">
        {% for producto in productos %}
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-4">
                {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" class="card-img-top" style="height:150px; object-fit:cover;">
                {% else %}
                <img src="{% static 'img/sin_imagen.png' %}" class="card-img-top" style="height:150px; object-fit:cover;">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ producto.nombre }}</h5>
                    <p class="text-muted small">{{ producto.descripcion|truncatechars:60 }}</p>
                    <p class="fw-bold">${{ producto.precio }}</p>
                    <div class="input-group mb-2">
                        <input type="number" min="1" value="1" id="cantidad_{{ producto.id }}" class="form-control">
                        <button class="btn btn-success" onclick="agregarProducto('{{ producto.id }}')">
                            <i class="fas fa-cart-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="d-grid mt-3">
    <button type="button" class="btn btn-primary" onclick="guardarPedido()">
        Guardar cambios del pedido
    </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ----------------------------------------
// Guardar cambios del pedido
// ----------------------------------------
function guardarPedido() {
    const form = document.getElementById('frm_editar_pedido');
    const formData = new FormData(form);

    fetch("{% url 'editar_pedido' pedido.id %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        Swal.fire({
            icon: "success",
            title: "Pedido actualizado",
            text: data.mensaje || "Cambios guardados correctamente",
            timer: 1500,
            showConfirmButton: false,
        });

        setTimeout(() => window.location.href = "{% url 'listar_pedidos' %}", 1500);
    });
}


// ----------------------------------------
// Agregar detalle (producto)
// ----------------------------------------
function agregarProducto(id) {
    let cantidad = document.getElementById(`cantidad_${id}`).value;

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ producto_id: id, cantidad: cantidad })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('tabla_detalles').innerHTML = data.tabla;

            Swal.fire({
                icon: "success",
                title: "Producto agregado",
                text: data.mensaje,
                timer: 1000,
                showConfirmButton: false
            });
        } else {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.mensaje
            });
        }
    });
}


// ----------------------------------------
// Editar detalle
// ----------------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual) {
    Swal.fire({
        title: "Editar cantidad",
        input: "number",
        inputLabel: "Nueva cantidad",
        inputValue: cantidad_actual,
        inputAttributes: {
            min: 1
        },
        showCancelButton: true,
        confirmButtonText: "Actualizar",
        cancelButtonText: "Cancelar"
    }).then((result) => {
        if (!result.isConfirmed) return;

        const nuevaCantidad = result.value;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ cantidad: nuevaCantidad })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Cantidad actualizada",
                    text: data.mensaje,
                    timer: 1500,
                    showConfirmButton: false
                });

            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje
                });
            }
        });
    });
}


// ----------------------------------------
// Eliminar detalle
// ----------------------------------------
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        text: "Esta acción no se puede deshacer",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Producto eliminado",
                    text: data.mensaje,
                    timer: 1500,
                    showConfirmButton: false
                });

            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje
                });
            }
        });
    });
}
</script>


<br><br><br>
{% endblock %}