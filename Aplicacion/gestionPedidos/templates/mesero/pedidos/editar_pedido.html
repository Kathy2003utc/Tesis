{% extends 'mesero/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<style>
    :root {
        --cafe-oscuro: #b4764f;
        --cafe-medio: #cd966c;
        --cafe-claro: #D7B999;
        --cafe-suave: #EEDDC6;

        --verde: #3E7A3F;
        --verde-claro: #7FBF6A;

        --blanco-calido: #F8F5F2;
        --gris-suave: #E2DED8;
        --texto-oscuro: #2B1A10;

        --rojo-alerta: #C14949;
        --rojo-oscuro: #8C2F39;
        --rojo-claro: #EA9A9A;

        --cafe-profundo: #8A5A3C;
        --cafe-tostado: #A66E4A;
        --cafe-avellana: #C8A784;
        --cafe-crema: #F0E1CA;

        --verde-profundo: #2E5F32;
        --verde-oliva: #5E7A43;
        --verde-menta: #A6D5A1;
        --verde-musgo: #507B4C;

        --crema-suave: #FAF4EC;
        --gris-claro-calido: #D8D3CC;
        --gris-medio-calido: #B8B1A8;
        --gris-oscuro-calido: #4A3F38;

        --exito: #4F8A57;
        --exito-suave: #D9F2D6;
        --info: #6A93B0;
        --info-suave: #DDE9F2;
        --advertencia: #D9A441;
        --advertencia-suave: #FFF5DA;

        --naranja-tierra: #D98555;
        --azul-pizarra: #4F6D7A;
    }
    /* --- SweetAlert estilo café-crema para éxito global --- */
    .swal-custom-success {
        background: var(--crema-suave) !important;
        border-radius: 18px !important;
        padding: 20px !important;
        width: 450px !important;
    }

    .swal-custom-success .swal2-html-container {
        color: var(--texto-oscuro) !important;
        font-size: 16px !important;
        font-weight: 500;
    }

    .swal-custom-success-icon-wrapper {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 4px solid #4F8A57;
        margin: 0 auto 15px auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .swal-custom-success-icon {
        font-size: 40px;
        color: #4F8A57;
    }

    .swal-custom-title {
        font-size: 22px;
        font-weight: 800;
        margin-bottom: 10px;
        color: var(--texto-oscuro);
    }

</style>

<div class="container mt-5" style="max-width: 900px;">
    <h2 class="text-center text-primary mb-4">Editar Pedido #{{ pedido.id }}</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Formulario para editar el pedido -->
    <form method="post" id="frm_editar_pedido">
        {% csrf_token %}
        <div class="row">

            <!-- MESA SOLO RESTAURANTE -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Mesa:</label>
                <select name="mesa" class="form-select" required>
                    {% for mesa in mesas %}
                        <option value="{{ mesa.id }}" 
                            {% if pedido.mesa.id == mesa.id %}selected{% endif %}>
                            Mesa {{ mesa.numero }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>

    <!-- Agregar productos -->
    <h4 class="mt-4">Agregar productos:</h4>
    <div class="row g-3">
        {% for producto in productos %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
            <div class="card border-0 shadow-sm rounded-4 h-100">

                <div class="p-2 d-flex flex-column">

                    <h6 class="fw-bold text-center small mb-1">{{ producto.nombre }}</h6>

                    <p class="text-muted small text-center mb-2" style="font-size: 0.75rem;">
                        {{ producto.descripcion }}
                    </p>

                    <p class="fw-bold text-success text-center mb-2" style="font-size: 0.9rem;">
                        ${{ producto.precio }}
                    </p>

                    <div class="d-flex flex-column mb-2">
                        <input type="number"
                            min="1"
                            value="1"
                            id="cantidad_{{ producto.id }}"
                            class="form-control form-control-sm mb-2">

                        <input type="text"
                            placeholder="Observación"
                            id="obs_{{ producto.id }}"
                            class="form-control form-control-sm mb-2">
                    </div>

                    <button class="btn btn-primary btn-sm w-100"
                            onclick="agregarProducto('{{ producto.id }}')">
                        Agregar
                    </button>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Tabla de detalles -->
    <h4 class="mt-5 text-center">Detalles del Pedido</h4>
    <div id="tabla_detalles">
        {% include 'mesero/pedidos/tabla_detalles.html' %}
    </div>

    <div class="text-center mt-4">
        <button type="submit" form="frm_editar_pedido" class="btn btn-primary">
            Finalizar & Ver pedido
        </button>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ----------------------------------------
// Agregar producto (solo restaurante)
// ----------------------------------------
function agregarProducto(id) {
    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" },
        body: JSON.stringify({ producto_id:id, cantidad, observacion })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            document.getElementById('tabla_detalles').innerHTML = data.tabla;
            Swal.fire({icon:'success', title:'Producto agregado', timer:1000, showConfirmButton:false});
            document.getElementById(`obs_${id}`).value = "";
        }
    });
}


// ----------------------------------------
// Editar detalle (sin recargo)
// ----------------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual) {

    let html = `
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
            <label>Cantidad</label>
            <input id="swal_cantidad" type="number" min="1" value="${cantidad_actual}" class="form-control">
            <label>Observación</label>
            <input id="swal_observacion" type="text" value="${observacion_actual || ''}" class="form-control">
        </div>
    `;

    Swal.fire({
        title: "Editar detalle",
        html: html,
        showCancelButton:true,
        confirmButtonText:"Actualizar",
        cancelButtonText:"Cancelar",
        preConfirm: () => {
            return {
                cantidad: parseInt(document.getElementById('swal_cantidad').value),
                observacion: document.getElementById('swal_observacion').value
            };
        }
    }).then(result=>{
        if(!result.isConfirmed) return;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method:"POST",
            headers:{"X-CSRFToken": "{{ csrf_token }}", "Content-Type":"application/json"},
            body:JSON.stringify(result.value)
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Detalle actualizado', timer:1400, showConfirmButton:false});
            }
        });
    });
}


// ----------------------------------------
// Eliminar detalle
// ----------------------------------------
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        icon:"warning",
        showCancelButton:true,
        confirmButtonText:"Sí, eliminar",
        cancelButtonText:"Cancelar"
    }).then(result=>{
        if(!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method:"POST",
            headers:{"X-CSRFToken":"{{ csrf_token }}"}
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Eliminado', timer:1500, showConfirmButton:false});
            }
        });
    });
}
</script>

<script>
// ------------------------------
// Validar que haya productos antes de finalizar
// ------------------------------
function validarProductos() {
    const filas = document.querySelectorAll("#tabla_detalles tbody tr");

    if (filas.length === 1 && filas[0].textContent.includes("Aún no hay productos")) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin productos',
            text: 'Debe agregar al menos un producto antes de finalizar.',
            background: "var(--crema-suave)",
            color: "var(--texto-oscuro)"
        });
        return false;
    }

    return true;
}

// ------------------------------
// SweetAlert con estilo del de CREAR pedido
// ------------------------------

document.getElementById("frm_editar_pedido").addEventListener("submit", function(e) {
    e.preventDefault(); // No envío tradicional

    if (!validarProductos()) return;

    let formData = new FormData(this);

    fetch("", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {

        if (data.success) {

            Swal.fire({
                icon: "success",
                title: "Pedido actualizado correctamente",
                text: "Redirigiendo...",
                background: "#fff",
                color: "var(--texto-oscuro)",
                showConfirmButton: false,
                timer: 1500
            });

            setTimeout(() => {
                // REDIRECCIÓN A ver_pedido
                window.location.href = `/pedidos/ver/${data.pedido_id}/`;
            }, 1500);

        } else {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.mensaje || "Ocurrió un error"
            });
        }

    })
    .catch(() => {
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "No se pudo actualizar el pedido."
        });
    });
});

</script>

<br><br><br>
{% endblock %}
