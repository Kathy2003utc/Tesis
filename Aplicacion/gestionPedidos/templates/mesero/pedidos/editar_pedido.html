{% extends 'mesero/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<div class="container mt-5" style="max-width: 900px;">
    <h2 class="text-center text-primary mb-4">Editar Pedido #{{ pedido.id }}</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Formulario para editar el pedido -->
    <form method="post" id="frm_editar_pedido">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Mesero:</label>
                <select name="mesero" class="form-select" required>
                    {% for m in meseros %}
                        <option value="{{ m.id }}" {% if pedido.mesero.id == m.id %}selected{% endif %}>
                            {{ m.nombre }} {{ m.apellido}}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- MESA SOLO RESTAURANTE -->
            <div class="col-md-4 mb-3">
                <label class="form-label">Mesa:</label>
                <select name="mesa" class="form-select" required>
                    {% for mesa in mesas %}
                        <option value="{{ mesa.id }}" {% if pedido.mesa.id == mesa.id %}selected{% endif %}>
                            Mesa {{ mesa.numero }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Estado:</label>
                <select name="estado" class="form-select">
                    <option value="en preparacion" {% if pedido.estado == 'en preparacion' %}selected{% endif %}>
                        En preparación
                    </option>
                    <option value="listo" {% if pedido.estado == 'listo' %}selected{% endif %}>Listo</option>
                    <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                </select>
            </div>
        </div>
    </form>

    <!-- Agregar productos -->
    <h4 class="mt-4">Agregar productos:</h4>
    <div class="row g-3">
        {% for producto in productos %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
            <div class="card border-0 shadow-sm rounded-4 h-100">

                <div class="p-2 d-flex flex-column">

                    <h6 class="fw-bold text-center small mb-1">{{ producto.nombre }}</h6>

                    <p class="text-muted small text-center mb-2" style="font-size: 0.75rem;">
                        {{ producto.descripcion }}
                    </p>

                    <p class="fw-bold text-success text-center mb-2" style="font-size: 0.9rem;">
                        ${{ producto.precio }}
                    </p>

                    <div class="d-flex flex-column mb-2">
                        <input type="number"
                            min="1"
                            value="1"
                            id="cantidad_{{ producto.id }}"
                            class="form-control form-control-sm mb-2">

                        <input type="text"
                            placeholder="Observación"
                            id="obs_{{ producto.id }}"
                            class="form-control form-control-sm mb-2">
                    </div>

                    <button class="btn btn-primary btn-sm w-100"
                            onclick="agregarProducto('{{ producto.id }}')">
                        Agregar
                    </button>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Tabla de detalles -->
    <h4 class="mt-5 text-center">Detalles del Pedido</h4>
    <div id="tabla_detalles">
        {% include 'mesero/pedidos/tabla_detalles.html' %}
    </div>

    <div class="text-center mt-4">
        <a href="{% url 'ver_pedido' pedido.id %}" class="btn btn-primary" id="btn_finalizar">
            Finalizar & Ver pedido
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ----------------------------------------
// Agregar producto (solo restaurante)
// ----------------------------------------
function agregarProducto(id) {
    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" },
        body: JSON.stringify({ producto_id:id, cantidad, observacion })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            document.getElementById('tabla_detalles').innerHTML = data.tabla;
            Swal.fire({icon:'success', title:'Producto agregado', timer:1000, showConfirmButton:false});
            document.getElementById(`obs_${id}`).value = "";
        }
    });
}


// ----------------------------------------
// Editar detalle (sin recargo)
// ----------------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual) {

    let html = `
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
            <label>Cantidad</label>
            <input id="swal_cantidad" type="number" min="1" value="${cantidad_actual}" class="form-control">
            <label>Observación</label>
            <input id="swal_observacion" type="text" value="${observacion_actual || ''}" class="form-control">
        </div>
    `;

    Swal.fire({
        title: "Editar detalle",
        html: html,
        showCancelButton:true,
        confirmButtonText:"Actualizar",
        cancelButtonText:"Cancelar",
        preConfirm: () => {
            return {
                cantidad: parseInt(document.getElementById('swal_cantidad').value),
                observacion: document.getElementById('swal_observacion').value
            };
        }
    }).then(result=>{
        if(!result.isConfirmed) return;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method:"POST",
            headers:{"X-CSRFToken": "{{ csrf_token }}", "Content-Type":"application/json"},
            body:JSON.stringify(result.value)
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Detalle actualizado', timer:1400, showConfirmButton:false});
            }
        });
    });
}


// ----------------------------------------
// Eliminar detalle
// ----------------------------------------
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        icon:"warning",
        showCancelButton:true,
        confirmButtonText:"Sí, eliminar",
        cancelButtonText:"Cancelar"
    }).then(result=>{
        if(!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method:"POST",
            headers:{"X-CSRFToken":"{{ csrf_token }}"}
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Eliminado', timer:1500, showConfirmButton:false});
            }
        });
    });
}
</script>

<br><br><br>
{% endblock %}
