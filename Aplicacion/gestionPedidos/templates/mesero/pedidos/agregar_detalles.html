{% extends 'mesero/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<style>

    :root {
        --cafe-oscuro: #b4764f;
        --cafe-medio: #cd966c;
        --cafe-claro: #D7B999;
        --cafe-suave: #EEDDC6;

        --verde: #3E7A3F;
        --verde-claro: #7FBF6A;

        --blanco-calido: #F8F5F2;
        --gris-suave: #E2DED8;
        --texto-oscuro: #2B1A10;

        --rojo-alerta: #C14949;
        --rojo-oscuro: #8C2F39;
        --rojo-claro: #EA9A9A;

        --cafe-profundo: #8A5A3C;
        --cafe-tostado: #A66E4A;
        --cafe-avellana: #C8A784;
        --cafe-crema: #F0E1CA;

        --verde-profundo: #2E5F32;
        --verde-oliva: #5E7A43;
        --verde-menta: #A6D5A1;
        --verde-musgo: #507B4C;

        --crema-suave: #FAF4EC;
        --gris-claro-calido: #D8D3CC;
        --gris-medio-calido: #B8B1A8;
        --gris-oscuro-calido: #4A3F38;

        --exito: #4F8A57;
        --exito-suave: #D9F2D6;
        --info: #6A93B0;
        --info-suave: #DDE9F2;
        --advertencia: #D9A441;
        --advertencia-suave: #FFF5DA;

        --naranja-tierra: #D98555;
        --azul-pizarra: #4F6D7A;
    }

/* Fondo general */
html, body {
    background: linear-gradient(135deg, var(--crema-suave), var(--cafe-suave) 45%, var(--blanco-calido));
    overflow-x: hidden;
}

/* Contenedor principal */
.container {
    background: rgba(255, 255, 255, 0.3);
    padding: 30px;
    margin: auto;
    border-radius: 20px;
}

/* Título */
.titulo-pedido {
    color: var(--cafe-profundo);
    font-weight: 800;
    text-shadow: 1px 1px 2px #ffffff70;
}

/* Tarjetas de producto */
.card-producto {
    background: var(--blanco-calido);
    border-radius: 15px;
    border: 1px solid var(--cafe-avellana);
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    transition: 0.3s;
}

.card-producto:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
}

/* Inputs */
.form-control {
    background: var(--blanco-calido);
    border: 1px solid var(--cafe-claro);
    border-radius: 12px;
    padding: 10px;
    color: var(--texto-oscuro);
}

/* Botón agregar */
.btn-agregar {
    background: var(--verde);
    color: white;
    border-radius: 12px;
    padding: 10px;
    font-weight: bold;
}

.btn-agregar:hover {
    background: var(--verde-claro);
    color: var(--texto-oscuro);
}

/* Tabla */
table {
    border-radius: 12px !important;
    overflow: hidden;
}

thead {
    background: var(--cafe-medio) !important;
    color: white;
}

tbody tr:hover {
    background: rgba(0,0,0,0.04);
}

/* Botones de tabla */
.btn-warning {
    background-color: var(--advertencia) !important;
    border-color: var(--advertencia) !important;
    color: white !important;
    font-weight: bold;
    border-radius: 8px;
    transition: 0.3s;
}

.btn-warning:hover { background-color: var(--advertencia) !important; color: var(--texto-oscuro) !important; }


.btn-danger {
        background-color: var(--rojo-alerta) !important;
        border-color: var(--rojo-alerta) !important;
        font-weight: bold;
        border-radius: 8px;
        transition: 0.3s;
    }
.btn-danger:hover { background-color: var(--rojo-claro) !important; color: var(--texto-oscuro) !important }


/* Botón Finalizar */
.btn-finalizar {
    background: var(--verde);
    color: white;
    padding: 15px;
    font-size: 18px;
    border-radius: 15px;
    font-weight: bold;
    transition: 0.3s;
}

.btn-finalizar:hover {
    background: var(--verde-claro);
    color: var(--texto-oscuro);
}

.main-content-wrapper {
    padding-left: 5px !important;
    padding-right: 5px !important;
}

@media (min-width: 768px) {
    .main-content-wrapper {
        padding-left: 40px !important;
        padding-right: 40px !important;
    }
}

@media (min-width: 1200px) {
    .main-content-wrapper {
        padding-left: 20px !important;
        padding-right: 20px !important;
    }
}

.content-card {
    background: var(--crema-suave);
    padding: 20px;
    border-radius: 18px;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
    border: 1px solid var(--cafe-suave);
}

.menu-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
}

/* Responsivo */
@media (max-width: 1200px) {
    .menu-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 992px) {
    .menu-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .menu-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .menu-grid {
        grid-template-columns: repeat(1, 1fr);
    }
}
</style>


<div class="main-content-wrapper">
    <div class="container mt-5 content-card">

        <h2 class="text-center titulo-pedido mb-4">
            Agregar Productos al Pedido #{{ pedido.id }}
        </h2>

        <div class="menu-grid">
            {% for producto in productos %}
            <div>
                <div class="card card-producto p-3 h-100">

                    <h5 class="fw-bold text-center mb-2" style="color: var(--cafe-profundo);">{{ producto.nombre }}</h5>

                    <p class="text-muted text-center small mb-2">
                        {{ producto.descripcion }}
                    </p>

                    <p class="fw-bold text-success text-center mb-2">
                        ${{ producto.precio }}
                    </p>

                    <label for="">Cantidad:</label>
                    <input type="number" min="1" value="1" id="cantidad_{{ producto.id }}" class="form-control mb-2">

                    <label for="">Observación:</label>
                    <input type="text" id="obs_{{ producto.id }}" class="form-control mb-2">

                    <button class="btn btn-agregar w-100"
                            onclick="agregarProducto('{{ producto.id }}')">
                        Agregar
                    </button>

                </div>
            </div>
            {% endfor %}
        </div>


        <!-- TABLA -->
        <h4 class="mt-5 text-center titulo-pedido">Detalles del Pedido</h4>

        <div id="tabla_detalles" class="table-responsive shadow rounded-4 mt-3">
            <table class="table table-bordered table-hover align-middle">
                <thead class="text-center">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Valor unitario</th>
                        <th>Subtotal</th>
                        <th>Observación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for det in pedido.detalles.all %}
                    <tr>
                        <td>{{ det.producto.nombre }}</td>
                        <td class="text-center">{{ det.cantidad }}</td>
                        <td class="text-center">${{ det.precio_unitario|floatformat:2 }}</td>
                        <td class="text-center">${{ det.subtotal }}</td>
                        <td>{{ det.observacion }}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm me-1"
                                onclick="editarDetalleAjax('{{ det.id }}', '{{ det.cantidad }}', '{{ det.observacion|default_if_none:''|escapejs }}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>

                            <br><br>

                            <button class="btn btn-danger btn-sm"
                                onclick="eliminarDetalleAjax('{{ det.id }}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-6">
                            Aún no hay productos agregados.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>


        <div class="text-center mt-4">
            <a href="{% url 'ver_pedido' pedido.id %}" 
            class="btn btn-finalizar" 
            id="btn_finalizar">
                Finalizar & Ver pedido
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ------------------------------
// Agregar producto (solo restaurante)
// ------------------------------
function agregarProducto(id) {
    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            producto_id: id,
            cantidad: cantidad,
            observacion: observacion
        })
    })
    .then(response => response.json())
    .then(data => {
        if(data.success){
            document.getElementById('tabla_detalles').innerHTML = data.tabla;
            Swal.fire({
                icon: 'success',
                title: 'Producto agregado',
                text: data.mensaje,
                timer: 1000,
                showConfirmButton: false
            });
            document.getElementById(`obs_${id}`).value = "";
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.mensaje
            });
        }
    });
}

// ------------------------------
// Editar detalle (sin recargos)
// ------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual) {

    Swal.fire({
        title: "Editar detalle",
        html: `
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <label>Cantidad</label>
                <input id="swal_cantidad" type="number" min="1"
                       value="${cantidad_actual}"
                       class="form-control">

                <label>Observación</label>
                <input id="swal_observacion" type="text"
                       value="${observacion_actual}"
                       class="form-control">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: "Actualizar",
        cancelButtonText: "Cancelar",
        preConfirm: () => {
            return {
                cantidad: parseInt(document.getElementById('swal_cantidad').value),
                observacion: document.getElementById('swal_observacion').value
            };
        }
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(result.value)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: 'success',
                    title: 'Detalle actualizado',
                    text: data.mensaje,
                    timer: 1400,
                    showConfirmButton: false
                });
            }
        });
    });
}


// ------------------------------
// Eliminar detalle
// ------------------------------
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, eliminar",
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: 'success',
                    title: 'Eliminado',
                    text: data.mensaje,
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        });
    });
}


// ------------------------------
// Validar antes de finalizar
// ------------------------------
function validarProductos() {
    const filas = document.querySelectorAll("#tabla_detalles tbody tr");

    if (filas.length === 1 && filas[0].textContent.includes("Aún no hay productos")) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin productos',
            text: 'Debe agregar al menos un producto antes de finalizar.',
        });
        return false;
    }

    return true;
}

document.getElementById("btn_finalizar").addEventListener("click", function(event){
    if (!validarProductos()) {
        event.preventDefault();
        return;
    }

    event.preventDefault();

    Swal.fire({
        icon: "success",
        title: "Pedido registrado correctamente",
        text: "Redirigiendo...",
        timer: 1500,
        showConfirmButton: false
    });

    setTimeout(() => {
        window.location.href = this.href; 
    }, 1500);
});
</script>

<br><br><br>
{% endblock %}
