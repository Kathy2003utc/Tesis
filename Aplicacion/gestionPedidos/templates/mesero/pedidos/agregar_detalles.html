{% extends 'mesero/plantilla.html' %}
{% load static %}
{% block contenido %}
<br>

<style>

    :root {
        --cafe-oscuro: #b4764f;
        --cafe-medio: #cd966c;
        --cafe-claro: #D7B999;
        --cafe-suave: #EEDDC6;

        --verde: #3E7A3F;
        --verde-claro: #7FBF6A;

        --blanco-calido: #F8F5F2;
        --gris-suave: #E2DED8;
        --texto-oscuro: #2B1A10;

        --rojo-alerta: #C14949;
        --rojo-oscuro: #8C2F39;
        --rojo-claro: #EA9A9A;

        --cafe-profundo: #8A5A3C;
        --cafe-tostado: #A66E4A;
        --cafe-avellana: #C8A784;
        --cafe-crema: #F0E1CA;

        --verde-profundo: #2E5F32;
        --verde-oliva: #5E7A43;
        --verde-menta: #A6D5A1;
        --verde-musgo: #507B4C;

        --crema-suave: #FAF4EC;
        --gris-claro-calido: #D8D3CC;
        --gris-medio-calido: #B8B1A8;
        --gris-oscuro-calido: #4A3F38;

        --exito: #4F8A57;
        --exito-suave: #D9F2D6;
        --info: #6A93B0;
        --info-suave: #DDE9F2;
        --advertencia: #D9A441;
        --advertencia-suave: #FFF5DA;

        --naranja-tierra: #D98555;
        --azul-pizarra: #4F6D7A;
    }

    /* Fondo general */
    html, body {
        background: linear-gradient(135deg, var(--crema-suave), var(--cafe-suave) 45%, var(--blanco-calido));
        overflow-x: hidden;
    }

    /* Contenedor principal */
    .container {
        background: rgba(255, 255, 255, 0.3);
        padding: 30px;
        margin: auto;
        border-radius: 20px;
    }

    /* Título */
    .titulo-pedido {
        color: var(--cafe-profundo);
        font-weight: 800;
        text-shadow: 1px 1px 2px #ffffff70;
    }

    /* Tarjetas de producto */
    .card-producto {
        background: var(--blanco-calido);
        border-radius: 15px;
        border: 1px solid var(--cafe-avellana);
        box-shadow: 0 8px 18px rgba(0,0,0,0.08);
        transition: 0.3s;
    }

    .card-producto:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
    }

    /* Inputs */
    .form-control {
        background: var(--blanco-calido);
        border: 1px solid var(--cafe-claro);
        border-radius: 12px;
        padding: 10px;
        color: var(--texto-oscuro);
    }

    /* Botón agregar */
    .btn-agregar {
        background: var(--verde);
        color: white;
        border-radius: 12px;
        padding: 10px;
        font-weight: bold;
    }

    .btn-agregar:hover {
        background: var(--verde-claro);
        color: var(--texto-oscuro);
    }

    /* Botones de tabla */
    .btn-warning {
        background-color: var(--advertencia) !important;
        border-color: var(--advertencia) !important;
        color: white !important;
        font-weight: bold;
        border-radius: 8px;
        transition: 0.3s;
    }

    .btn-warning:hover { 
        background-color: var(--advertencia) !important; 
        color: var(--texto-oscuro) !important; 
    }

    .btn-danger {
        background-color: var(--rojo-alerta) !important;
        border-color: var(--rojo-alerta) !important;
        font-weight: bold;
        border-radius: 8px;
        transition: 0.3s;
        color: white !important;
    }

    .btn-danger:hover { 
        background-color: var(--rojo-claro) !important; 
        color: var(--texto-oscuro) !important; 
    }

    /* Botón Finalizar */
    .btn-finalizar {
        background: var(--verde);
        color: white;
        padding: 15px;
        font-size: 18px;
        border-radius: 15px;
        font-weight: bold;
        transition: 0.3s;
    }

    .btn-finalizar:hover {
        background: var(--verde-claro);
        color: var(--texto-oscuro);
    }

    .main-content-wrapper {
        padding-left: 5px !important;
        padding-right: 5px !important;
    }

    @media (min-width: 768px) {
        .main-content-wrapper {
            padding-left: 40px !important;
            padding-right: 40px !important;
        }
    }

    @media (min-width: 1200px) {
        .main-content-wrapper {
            padding-left: 20px !important;
            padding-right: 20px !important;
        }
    }

    .content-card {
        background: var(--crema-suave);
        padding: 10px;
        border-radius: 18px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
        border: 1px solid var(--cafe-suave);
    }

    .menu-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    /* Responsivo */
    @media (max-width: 1200px) {
        .menu-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    @media (max-width: 992px) {
        .menu-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .menu-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .menu-grid {
            grid-template-columns: repeat(1, 1fr);
        }
    }

    /* ===============================
       TABLA DETALLES – MISMO ESTILO
       ================================ */

    #tbl_detalles {
        min-width: 900px;
    }

    #tbl_detalles thead th {
        background-color: var(--cafe-crema);
        color: var(--texto-oscuro);
        font-size: 15px;
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        border-bottom: 2px solid var(--cafe-medio);
    }

    #tbl_detalles tbody td {
        text-align: center;
        vertical-align: middle;
    }

    #tbl_detalles tbody tr:hover {
        background-color: var(--gris-suave);
    }

    #tbl_detalles td:last-child {
        white-space: nowrap;
    }

    #tbl_detalles tfoot .fila-total {
        background-color: var(--cafe-suave);
        font-size: 1.1rem;
        font-weight: bold;
    }

    .producto-agotado {
        opacity: .55;
        filter: grayscale(100%);
    }

    .producto-agotado .btn-agregar {
        cursor: not-allowed;
    }

    .producto-agotado .btn-agregar:disabled {
        opacity: 1; /* que no se vea “doblemente” apagado */
    }

    /* Botón Cancelar pedido */
    .btn-cancelar {
        background: var(--rojo-alerta);
        color: white;
        padding: 15px;
        font-size: 18px;
        border-radius: 15px;
        font-weight: bold;
        transition: 0.3s;
        border: none;
    }

    .btn-cancelar:hover {
        background: var(--rojo-claro);
        color: var(--texto-oscuro);
    }


</style>


<div class="main-content-wrapper">
    <div class="container mt-5 content-card">

        <h2 class="text-center titulo-pedido mb-4">
            Agregar Productos al Pedido {{ pedido.codigo_pedido }}
        </h2>

        <div class="menu-grid">
            {% for producto in productos %}
            <div>
                <div class="card card-producto p-3 h-100 {% if producto.agotado_hoy %}producto-agotado{% endif %}"
                    data-producto-id="{{ producto.id }}">

                    <h5 class="fw-bold text-center mb-2" style="color: var(--cafe-profundo);">
                        {{ producto.nombre }}

                        {% if producto.agotado_hoy %}
                        <span class="badge bg-secondary ms-2">Agotado hoy</span>
                        {% endif %}
                    </h5>

                    <p class="text-muted text-center small mb-2">
                        {{ producto.descripcion }}
                    </p>

                    <p class="fw-bold text-success text-center mb-2">
                        ${{ producto.precio }}
                    </p>

                    <label for="">Cantidad:</label>
                    <input type="number" min="1" value="1"
                        id="cantidad_{{ producto.id }}"
                        class="form-control mb-2"
                        {% if producto.agotado_hoy %}disabled{% endif %}>

                    <label for="">Observación:</label>
                    <input type="text"
                        id="obs_{{ producto.id }}"
                        class="form-control mb-2"
                        {% if producto.agotado_hoy %}disabled{% endif %}>

                    <button class="btn btn-agregar w-100"
                            data-producto-id="{{ producto.id }}"
                            {% if producto.agotado_hoy %}disabled{% endif %}
                            onclick="agregarProducto('{{ producto.id }}')">
                    Agregar
                    </button>


                </div>
            </div>
            {% endfor %}

        </div>


        <!-- TABLA -->
        <h4 class="mt-5 text-center titulo-pedido">Detalles del Pedido</h4>

        <div id="tabla_detalles" class="table-responsive mt-3">
            <table class="table table-bordered table-hover align-middle" id="tbl_detalles">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Valor unitario</th>
                        <th>Subtotal</th>
                        <th>Observación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for det in pedido.detalles.all %}
                    <tr>
                        <td>{{ det.producto.nombre }}</td>
                        <td class="text-center">{{ det.cantidad }}</td>
                        <td class="text-center">${{ det.precio_unitario|floatformat:2 }}</td>
                        <td class="text-center">${{ det.subtotal|floatformat:2 }}</td>
                        <td>{{ det.observacion }}</td>
                        <td class="text-center">
                            <button class="btn btn-warning btn-sm me-1"
                                onclick="editarDetalleAjax('{{ det.id }}', '{{ det.cantidad }}', '{{ det.observacion|default_if_none:''|escapejs }}')">
                                <i class="fas fa-edit"></i>
                            </button>

                            <button class="btn btn-danger btn-sm mt-2"
                                onclick="eliminarDetalleAjax('{{ det.id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            Aún no hay productos agregados.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

                {% if pedido.detalles.all %}
                <tfoot>
                    <tr class="fila-total">
                        <td colspan="3" class="text-end">TOTAL FINAL:</td>
                        <td class="text-center text-success">
                            ${{ pedido.total|floatformat:2 }}
                        </td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>


        <div class="d-flex justify-content-center gap-3 mt-4 flex-wrap">

            <!-- Finalizar -->
            <a href="{% url 'ver_pedido' pedido.id %}" 
            class="btn btn-finalizar"
            id="btn_finalizar"
            style="min-width:260px;">
                Finalizar & Ver pedido
            </a>

            <!-- Cancelar -->
            <form method="post"
                action="{% url 'mesero_cancelar_pedido' pedido.id %}"
                id="frm_cancelar_pedido">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-cancelar"
                        style="min-width:260px;">
                    Cancelar pedido
                </button>
            </form>

        </div>



    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ------------------------------
// Agregar producto (solo restaurante)
// ------------------------------
function agregarProducto(id) {
    const btn = document.querySelector(`button[data-producto-id="${id}"]`);
    if (btn && btn.disabled) {
        Swal.fire({
            icon: "warning",
            title: "Agotado hoy",
            text: "Este producto está agotado hoy y no se puede agregar.",
            confirmButtonColor: "#3E7A3F",
            confirmButtonText: "Aceptar",
            background: "#FFF7F0",
            iconColor: "#D9A441"
        });
        return;
    }

    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;

    // VALIDACIÓN
    if (isNaN(cantidad) || cantidad <= 0) {
        Swal.fire({
            icon: "warning",
            title: "Cantidad inválida",
            text: "Ingrese una cantidad mayor a 0",
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#3E7A3F",
            background: "#FFF7F0",
            iconColor: "#D9A441"
        });
        return;
    }

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            producto_id: id,
            cantidad: cantidad,
            observacion: observacion
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('tabla_detalles').innerHTML = data.tabla;

            Swal.fire({
                icon: 'success',
                title: 'Producto agregado',
                text: data.mensaje,
                timer: 1200,
                showConfirmButton: false,
                background: "#FFF7F0",
                iconColor: "#3E7A3F"
            });

            document.getElementById(`obs_${id}`).value = "";
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.mensaje || "No se pudo agregar el producto.",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949",
                background: "#FFF7F0",
                iconColor: "#C14949"
            });
        }
    })
    .catch(() => {
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "Falló la petición (revisa Network/Console).",
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#C14949",
            background: "#FFF7F0",
            iconColor: "#C14949"
        });
    });
}


// ------------------------------
// Editar detalle (sin recargos)
// ------------------------------
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual) {

    Swal.fire({
        title: "Editar detalle",
        html: `
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                <label>Cantidad</label>
                <input id="swal_cantidad" type="number" min="1"
                       value="${cantidad_actual}" class="form-control">

                <label>Observación</label>
                <input id="swal_observacion" type="text"
                       value="${observacion_actual}" class="form-control">
            </div>
        `,
        background: "#FFF7F0",
        showCancelButton: true,
        confirmButtonText: "Actualizar",
        cancelButtonText: "Cancelar",
        confirmButtonColor: "#3E7A3F",
        cancelButtonColor: "#C14949",
        preConfirm: () => {
            const cantidad = parseInt(document.getElementById('swal_cantidad').value);
            const observacion = document.getElementById('swal_observacion').value;

            // VALIDACIÓN (importante: return false para que NO cierre el swal)
            if (isNaN(cantidad) || cantidad <= 0) {
                Swal.showValidationMessage("La cantidad debe ser mayor a 0");
                return false;
            }

            return { cantidad, observacion };
        }
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(result.value)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: 'success',
                    title: 'Detalle actualizado',
                    text: data.mensaje,
                    timer: 1400,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje || "No se pudo actualizar el detalle.",
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#C14949",
                    background: "#FFF7F0",
                    iconColor: "#C14949"
                });
            }
        })
        .catch(() => {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Falló la petición (revisa Network/Console).",
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#C14949",
                background: "#FFF7F0",
                iconColor: "#C14949"
            });
        });
    });
}

// ------------------------------
// Eliminar detalle
// ------------------------------
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        text: "Este producto será eliminado del pedido.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Eliminar",
        cancelButtonText: "Cancelar",
        confirmButtonColor: "#C14949",
        cancelButtonColor: "#4F6D7A",
        background: "#FFF7F0"
    }).then((result) => {
        if (!result.isConfirmed) return;

        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;

                Swal.fire({
                    icon: 'success',
                    title: 'Eliminado',
                    text: data.mensaje,
                    timer: 1500,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.mensaje || "No se pudo eliminar el producto.",
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#C14949",
                    background: "#FFF7F0"
                });
            }
        });
    });
}


// ------------------------------
// Validar antes de finalizar
// ------------------------------
function validarProductos() {
    const filas = document.querySelectorAll("#tabla_detalles tbody tr");

    if (filas.length === 1 && filas[0].textContent.includes("Aún no hay productos")) {
        Swal.fire({
            icon: 'warning',
            title: 'Sin productos',
            text: 'Debe agregar al menos un producto antes de finalizar.',
            confirmButtonText: "Aceptar",
            confirmButtonColor: "#3E7A3F",
            background: "#FFF7F0",
            iconColor: "#D9A441"
        });
        return false;
    }

    return true;
}

document.getElementById("btn_finalizar").addEventListener("click", function(event){
    if (!validarProductos()) {
        event.preventDefault();
        return;
    }

    event.preventDefault();

    Swal.fire({
        icon: "success",
        title: "Pedido registrado correctamente",
        text: "Redirigiendo...",
        timer: 1500,
        showConfirmButton: false,
        background: "#FFF7F0",
        iconColor: "#3E7A3F"
    });

    setTimeout(() => {
        window.location.href = this.href; 
    }, 1500);
});

</script>

<script>
const frmCancelar = document.getElementById("frm_cancelar_pedido");
if (frmCancelar) {
  frmCancelar.addEventListener("submit", function(e){
    e.preventDefault();
    Swal.fire({
      icon: "warning",
      title: "¿Cancelar pedido?",
      text: "Se eliminará el pedido completo (con sus productos) y se liberará la mesa.",
      showCancelButton: true,
      confirmButtonText: "Sí, cancelar",
      cancelButtonText: "No",
      confirmButtonColor: "#C14949",
      cancelButtonColor: "#4F6D7A",
      background: "#FFF7F0"
    }).then((r)=>{
      if(r.isConfirmed) frmCancelar.submit();
    });
  });
}
</script>


<br>
{% endblock %}
