{% extends 'administrador/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<div class="container mt-5" style="max-width: 800px;">
    <h2 class="text-center text-primary mb-4">Pedido #{{ pedido.id }}</h2>

    <div class="card p-4 shadow rounded-4 mt-4">
        <p><strong>Mesero:</strong> {{ pedido.mesero.nombre }} {{ pedido.mesero.apellido }}</p>
        <p><strong>Mesa:</strong>
            {% if pedido.mesa %}
                {{ pedido.mesa.numero }}
            {% else %}
                Domicilio
            {% endif %}
        </p>

        <p><strong>Estado:</strong> {{ pedido.estado }}</p>
        <p><strong>Total:</strong> ${{ pedido.total }}</p>
    </div>

    <!-- Tabla de detalles -->
    <h4 class="mt-4">Detalles del pedido:</h4>
    <div id="tabla_detalles">
        {% include 'mesero/pedidos/tabla_detalles.html' %}
    </div>

    <!-- Agregar productos -->
    <h4 class="mt-4">Agregar productos:</h4>
    <div class="row">
        {% for producto in productos %}
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-4">
                {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" class="card-img-top" style="height:150px; object-fit:cover;">
                {% else %}
                <img src="{% static 'img/sin_imagen.png' %}" class="card-img-top" style="height:150px; object-fit:cover;">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ producto.nombre }}</h5>
                    <p class="text-muted small">{{ producto.descripcion|truncatechars:60 }}</p>
                    <p class="fw-bold">${{ producto.precio }}</p>
                    <div class="input-group mb-2">
                        <input type="number" min="1" value="1" id="cantidad_{{ producto.id }}" class="form-control">
                        <button class="btn btn-success" onclick="agregarProducto('{{ producto.id }}')">
                            <i class="fas fa-cart-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Agregar producto al pedido
function agregarProducto(id) {
    let cantidad = document.getElementById(`cantidad_${id}`).value;

    fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ producto_id: id, cantidad: cantidad })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.mensaje);
        document.getElementById('tabla_detalles').innerHTML = data.tabla;
    });
}

// Editar detalle con AJAX
function editarDetalleAjax(detalle_id) {
    let cantidad = prompt("Ingrese la nueva cantidad:");

    if (cantidad) {
        fetch(`/pedidos/detalle/editar_ajax/${detalle_id}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ cantidad: cantidad })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.mensaje);
            document.getElementById('tabla_detalles').innerHTML = data.tabla;
        });
    }
}

// Eliminar detalle con AJAX
function eliminarDetalleAjax(detalle_id) {
    if (confirm("Â¿Eliminar este producto del pedido?")) {
        fetch(`/pedidos/detalle/eliminar_ajax/${detalle_id}/`, {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(data => {
            alert(data.mensaje);
            document.getElementById('tabla_detalles').innerHTML = data.tabla;
        });
    }
}
</script>

<br><br><br>
{% endblock %}
