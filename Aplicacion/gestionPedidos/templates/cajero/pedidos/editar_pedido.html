{% extends 'administrador/plantilla.html' %}
{% load static %}
{% block contenido %}
<br><br><br>

<div class="container mt-5" style="max-width: 900px;">
    <h2 class="text-center text-primary mb-4">Editar Pedido #{{ pedido.id }}</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Formulario para editar el pedido -->
    <form method="post" id="frm_editar_pedido">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Mesero:</label>
                <select name="mesero" class="form-select" required>
                    {% for m in meseros %}
                        <option value="{{ m.id }}" {% if pedido.mesero.id == m.id %}selected{% endif %}>
                            {{ m.nombre }} {{ m.apellido}}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Mesa:</label>
                <select name="mesa" class="form-select">
                    <option value="">Sin mesa (domicilio)</option>
                    {% for mesa in mesas %}
                        <option value="{{ mesa.id }}" {% if pedido.mesa.id == mesa.id %}selected{% endif %}>
                            Mesa {{ mesa.numero }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label">Estado:</label>
                <select name="estado" class="form-select">
                    <option value="en preparacion" {% if pedido.estado == 'en preparacion' %}selected{% endif %}>
                        En preparación
                    </option>
                    <option value="listo" {% if pedido.estado == 'listo' %}selected{% endif %}>Listo</option>
                    <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                </select>
            </div>
        </div>
    </form>

    <!-- Agregar productos -->
    <h4 class="mt-4">Agregar productos:</h4>
    <div class="row g-3">
        {% for producto in productos %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
            <div class="card border-0 shadow-sm rounded-4 h-100" style="padding-bottom: 0 !important;">
                <div class="ratio ratio-16x9">
                    {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" class="object-fit-cover w-100 h-100 rounded-top-4">
                    {% else %}
                        <img src="{% static 'img/sin_imagen.png' %}" class="object-fit-cover w-100 h-100 rounded-top-4">
                    {% endif %}
                </div>

                <div class="p-2 d-flex flex-column" style="padding-bottom: 0 !important;">

                    <h6 class="fw-bold text-center small mb-1">{{ producto.nombre }}</h6>

                    <p class="text-muted small text-center mb-2" style="font-size: 0.75rem;">
                        {{ producto.descripcion }}
                    </p>

                    <p class="fw-bold text-success text-center mb-2" style="font-size: 0.9rem;">
                        ${{ producto.precio }}
                    </p>

                    <div class="d-flex flex-column mb-2" style="margin-bottom: 0 !important;">
                        <input type="number"
                            min="1"
                            value="1"
                            id="cantidad_{{ producto.id }}"
                            class="form-control form-control-sm mb-2">

                        <input type="text"
                            placeholder="Observación"
                            id="obs_{{ producto.id }}"
                            class="form-control form-control-sm mb-2">
                    </div>

                    <button class="btn btn-primary btn-sm w-100"
                            style="margin-bottom: 0 !important;"
                            onclick="agregarProducto('{{ producto.id }}')">
                        Agregar
                    </button>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Tabla de detalles -->
    <h4 class="mt-5 text-center">Detalles del Pedido</h4>
    <div id="tabla_detalles">
        {% include 'mesero/pedidos/tabla_detalles.html' %}
    </div>

    <div class="text-center mt-4">
        <a href="{% url 'ver_pedido' pedido.id %}" class="btn btn-primary" id="btn_finalizar">
            Finalizar & Ver pedido
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ----------------------------------------
// Funciones agregar/editar/eliminar productos
// ----------------------------------------

// Agregar producto
function agregarProducto(id) {
    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;
    const tipoPedido = "{{ pedido.tipo_pedido }}";

    if(tipoPedido === "domicilio") {
        Swal.fire({
            title: 'Recargo por envase/desechable',
            input: 'number',
            inputLabel: 'Ingrese el valor unitario del recargo',
            inputValue: 0,
            inputAttributes: { min: 0, step: 0.01 },
            showCancelButton: true,
            confirmButtonText: 'Agregar producto',
            cancelButtonText: 'Cancelar',
            preConfirm: valorRecargo => {
                if(valorRecargo === "" || isNaN(valorRecargo) || valorRecargo < 0) {
                    Swal.showValidationMessage("Ingrese un valor válido para el recargo");
                }
                return parseFloat(valorRecargo);
            }
        }).then(result => {
            if(!result.isConfirmed) return;
            fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ producto_id:id, cantidad, observacion, recargo: result.value })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    document.getElementById('tabla_detalles').innerHTML = data.tabla;
                    Swal.fire({icon:'success', title:'Producto agregado', timer:1000, showConfirmButton:false});
                    document.getElementById(`obs_${id}`).value = "";
                } else {
                    Swal.fire({icon:'error', title:'Error', text:data.mensaje});
                }
            });
        });
    } else {
        fetch("{% url 'agregar_detalle_ajax' pedido.id %}", {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/json" },
            body: JSON.stringify({ producto_id:id, cantidad, observacion })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Producto agregado', timer:1000, showConfirmButton:false});
                document.getElementById(`obs_${id}`).value = "";
            } else {
                Swal.fire({icon:'error', title:'Error', text:data.mensaje});
            }
        });
    }
}

// Editar detalle
function editarDetalleAjax(detalle_id, cantidad_actual, observacion_actual, recargo_actual=0) {
    const tipoPedido = "{{ pedido.tipo_pedido }}";
    let html = `<div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                    <label>Cantidad</label>
                    <input id="swal_cantidad" type="number" min="1" value="${cantidad_actual}" class="form-control">
                    <label>Observación</label>
                    <input id="swal_observacion" type="text" value="${observacion_actual || ''}" class="form-control">`;

    if(tipoPedido === "domicilio") {
        html += `<label>Recargo</label>
                 <input id="swal_recargo" type="number" min="0" step="0.01" value="${recargo_actual}" class="form-control">`;
    }
    html += `</div>`;

    Swal.fire({
        title: "Editar detalle",
        html: html,
        showCancelButton:true,
        confirmButtonText:"Actualizar",
        cancelButtonText:"Cancelar",
        preConfirm: () => {
            const result = { cantidad: parseInt(document.getElementById('swal_cantidad').value),
                             observacion: document.getElementById('swal_observacion').value };
            if(tipoPedido==="domicilio") result.recargo = parseFloat(document.getElementById('swal_recargo').value)||0;
            return result;
        }
    }).then(result=>{
        if(!result.isConfirmed) return;
        fetch("{% url 'editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method:"POST",
            headers:{"X-CSRFToken": "{{ csrf_token }}", "Content-Type":"application/json"},
            body:JSON.stringify(result.value)
        })
        .then(res=>res.json())
        .then(data=>{
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Detalle actualizado', timer:1400, showConfirmButton:false});
            } else {
                Swal.fire({icon:'error', title:'Error', text:data.mensaje});
            }
        });
    });
}

// Eliminar detalle
function eliminarDetalleAjax(detalle_id) {
    Swal.fire({
        title: "¿Eliminar producto?",
        icon:"warning",
        showCancelButton:true,
        confirmButtonColor:"#d33",
        cancelButtonColor:"#3085d6",
        confirmButtonText:"Sí, eliminar",
        cancelButtonText:"Cancelar"
    }).then(result=>{
        if(!result.isConfirmed) return;
        fetch("{% url 'eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method:"POST",
            headers:{"X-CSRFToken":"{{ csrf_token }}"}
        }).then(res=>res.json())
          .then(data=>{
            if(data.success){
                document.getElementById('tabla_detalles').innerHTML = data.tabla;
                Swal.fire({icon:'success', title:'Eliminado', timer:1500, showConfirmButton:false});
            } else {
                Swal.fire({icon:'error', title:'Error', text:data.mensaje});
            }
        });
    });
}
</script>

<br><br><br>
{% endblock %}
