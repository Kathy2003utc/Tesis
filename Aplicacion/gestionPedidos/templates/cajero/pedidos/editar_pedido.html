{% extends 'cajero/plantilla.html' %}
{% load static %}

{% block contenido %}
<br>

<style>
:root {
    --cafe-oscuro: #b4764f;
    --cafe-medio: #cd966c;
    --cafe-claro: #D7B999;
    --cafe-suave: #EEDDC6;

    --verde: #3E7A3F;
    --verde-claro: #7FBF6A;

    --blanco-calido: #F8F5F2;
    --gris-suave: #E2DED8;
    --texto-oscuro: #2B1A10;

    --rojo-alerta: #C14949;
    --rojo-oscuro: #8C2F39;
    --rojo-claro: #EA9A9A;

    --cafe-profundo: #8A5A3C;
    --cafe-tostado: #A66E4A;
    --cafe-avellana: #C8A784;
    --cafe-crema: #F0E1CA;

    --verde-profundo: #2E5F32;
    --verde-oliva: #5E7A43;
    --verde-menta: #A6D5A1;
    --verde-musgo: #507B4C;

    --crema-suave: #FAF4EC;
    --gris-claro-calido: #D8D3CC;
    --gris-medio-calido: #B8B1A8;
    --gris-oscuro-calido: #4A3F38;

    --exito: #4F8A57;
    --exito-suave: #D9F2D6;
    --advertencia: #D9A441;
    --advertencia-suave: #FFF5DA;
}

/* Fondo */
html,body{
    background: linear-gradient(
        135deg,
        var(--crema-suave),
        var(--cafe-suave) 45%,
        var(--blanco-calido)
    );
}

/* Contenedor principal */
.wrapper-editar{
    max-width: 1100px;
    margin: auto;
    background: var(--blanco-calido);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 12px 28px rgba(0,0,0,.12);
}

/* Título */
.titulo-editar{
    text-align:center;
    font-weight:800;
    color:var(--cafe-oscuro);
    margin-bottom:25px;
}

/* ===== DATOS PEDIDO ===== */
.card-datos{
    border: 1px solid var(--cafe-avellana);
    background: var(--crema-suave);
    border-radius:18px;
    padding:10px;
    box-shadow:0 6px 16px rgba(0,0,0,.08);
    margin-bottom:30px;
}

.card-datos h5{
    font-weight:700;
    color:var(--cafe-oscuro);
    margin-bottom:15px;
}

.grid-datos{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
}

.grid-datos label{
    font-weight:600;
    color:#5a4636;
}

.form-control{
    border-radius:12px;
    border:1px solid var(--cafe-claro);
}

/* ===== PRODUCTOS ===== */
.titulo-seccion{
    text-align:center;
    font-weight:800;
    color:var(--cafe-oscuro);
    margin:40px 0 20px;
}

.grid-productos{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
}

.card-producto {
    background: var(--crema-suave);
    border-radius: 15px;
    border: 1px solid var(--cafe-avellana);
    box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    transition: 0.3s;

    display: flex;
    flex-direction: column;
    padding: 14px;
}

.card-producto:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 22px rgba(0,0,0,0.15);
}

.card-producto h5 {
    min-height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    text-align: center;
    color: var(--cafe-profundo);
}

.card-producto h6{
    font-weight:700;
    text-align:center;
    min-height:40px;
}

.card-producto p{
    text-align: center;
    font-size: .85rem;
    line-height: 1.4;
    color: #6b6b6b;
}

.card-producto p.text-muted {
    min-height: 48px;
    max-height: 48px;
    overflow: hidden;
    text-overflow: ellipsis;
}

.card-producto .btn{
    margin-top:auto;
    border-radius:12px;
    font-weight:700;
}

/* ===== BOTONES ===== */
.btn-agregar{
    background:var(--verde);
    color:white;
}
.btn-agregar:hover{
    background:var(--verde-claro);
    color:var(--texto);
}

.card-producto .btn-agregar{
    margin-top: auto;
    width: 100%;
    border-radius: 12px;
    font-weight: bold;
}

.btn-final{
    background:var(--verde);
    color:white;
    font-weight:700;
    padding:14px 28px;
    border-radius:16px;
}
.btn-final:hover{
    background:var(--verde-claro);
    color:var(--texto);
}

/* Responsive */
@media (max-width: 576px) {

    .pedido-wrapper{
        padding: 10px;
    }

    .content-card{
        padding: 12px;
        border-radius: 14px;
    }

    .titulo-pedido{
        font-size: 1.2rem;
        line-height: 1.3;
    }

    .card-producto{
        padding: 12px;
    }

    .card-producto h5{
        min-height: auto;
        font-size: 1rem;
    }

    .card-producto p.text-muted{
        min-height: auto;
        max-height: none;
        font-size: .85rem;
    }

    .btn-agregar{
        padding: 12px;
        font-size: .95rem;
    }
}

.precio-producto{
    font-size: 1.6rem;    
    font-weight: 800;
    color: var(--exito);
    margin: 6px 0 10px;
    letter-spacing: 0.5px;
}

</style>

<div class="main-content-wrapper">
    <div class="wrapper-editar mt-5">

        <!-- TÍTULO -->
        <h2 class="titulo-editar text-center mb-4">
            Editar Pedido a Domicilio {{ pedido.codigo_pedido }}
        </h2>

        <!-- DATOS DEL PEDIDO -->
        <div class="card-datos">
            <h5>Datos del pedido</h5>

            <form method="post" id="frm_editar_pedido">
                {% csrf_token %}
                <div class="grid-datos">
                    <div>
                        <label>Cliente</label>
                        <input type="text" name="nombre_cliente" class="form-control"
                               value="{{ pedido.nombre_cliente }}">
                    </div>

                    <div>
                        <label>Contacto</label>
                        <input type="text" name="contacto_cliente" class="form-control"
                               value="{{ pedido.contacto_cliente }}">
                    </div>

                    <div>
                        <label>Dirección</label>
                        <input type="text" name="direccion_entrega" class="form-control"
                               value="{{ pedido.direccion_entrega }}">
                    </div>
                </div>
            </form>
        </div>

        <!-- PRODUCTOS -->
        <h4 class="titulo-seccion">Agregar productos</h4>

        <div class="grid-productos">
            {% for producto in productos %}
            <div>
                <div class="card-producto h-100">

                    <h5 class="fw-bold text-center mb-2" style="color: var(--cafe-profundo);">
                        {{ producto.nombre }}
                    </h5>

                    <p class="text-muted text-center small mb-2">
                        {{ producto.descripcion }}
                    </p>

                    <p class="precio-producto text-center">
                        ${{ producto.precio }}
                    </p>

                    <label>Cantidad:</label>
                    <input type="number" min="1" value="1"
                        id="cantidad_{{ producto.id }}"
                        class="form-control mt-2">

                    <label>Observación:</label>
                    <input type="text"
                        placeholder="Observación"
                        id="obs_{{ producto.id }}"
                        class="form-control mt-2">

                    <button class="btn btn-agregar mt-3 w-100"
                            onclick="agregarProducto('{{ producto.id }}')">
                        Agregar
                    </button>

                </div>
            </div>
            {% endfor %}
        </div>



        <!-- TABLA -->
        <h4 class="titulo-seccion">Detalles del pedido</h4>
        <div id="tabla_detalles">
            {% include 'cajero/pedidos/tabla_detalles_acciones.html' %}
        </div>

        <!-- ACCIÓN FINAL -->
        <div class="text-center mt-4">
            <button form="frm_editar_pedido" class="btn btn-final">
                Guardar cambios y ver pedido
            </button>
        </div>

    </div>
</div>



<!-- ========================================================= -->
<!-- ======================== SCRIPTS ========================= -->
<!-- ========================================================= -->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// -------------------------------------------------------------
// Agregar producto CON RECARGO
// -------------------------------------------------------------
function agregarProducto(id) {
    let cantidad = parseInt(document.getElementById(`cantidad_${id}`).value);
    let observacion = document.getElementById(`obs_${id}`).value;

    if (isNaN(cantidad) || cantidad <= 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Cantidad inválida',
            text: 'Ingrese una cantidad mayor a 0',
            background: "#FFF7F0"
        });
        return;
    }

    Swal.fire({
        title: 'Recargo por envase / domicilio',
        input: 'number',
        inputLabel: 'Valor unitario (0.25, 0.30, etc)',
        inputPlaceholder: '0.00',
        inputAttributes: {
            min: 0,
            step: 0.01
        },
        showCancelButton: true,
        confirmButtonText: 'Agregar producto',
        cancelButtonText: 'Cancelar',
        background: "#FFF7F0",
        confirmButtonColor: "#3E7A3F",
        cancelButtonColor: "#C14949",
        preConfirm: (valor) => {
            if (valor === '' || isNaN(valor) || valor < 0) {
                Swal.showValidationMessage("Ingrese un valor válido");
            }
            return parseFloat(valor || 0);
        }
    }).then(result => {
        if (!result.isConfirmed) return;

        const recargo_unitario = result.value;
        const recargo_total = recargo_unitario * cantidad;

        fetch("{% url 'cajero_agregar_detalle_ajax' pedido.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                producto_id: id,
                cantidad,
                observacion,
                recargo_unitario,
                recargo_total
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("tabla_detalles").innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Producto agregado",
                    timer: 1200,
                    background: "#FFF7F0",
                    showConfirmButton: false,
                    iconColor: "#3E7A3F"
                });

                document.getElementById(`obs_${id}`).value = "";
            }
        });
    });
}

</script>


<script>
// -------------------------------------------------------------
// Editar detalle (cantidad, observación, recargo)
// -------------------------------------------------------------
function editarDetalleAjax(detalle_id, cantidad, observacion, recargo) {

    let html = `
        <label>Cantidad</label>
        <input id="sw_cantidad" type="number" min="1" value="${cantidad}" class="form-control">

        <label>Observación</label>
        <input id="sw_obs" type="text" value="${observacion}" class="form-control">

        <label>Recargo unitario ($)</label>
        <input id="sw_recargo" type="number" min="0" step="0.01" value="${recargo}" class="form-control">
    `;

    Swal.fire({
        title: "Editar detalle",
        html: html,
        showCancelButton: true,
        confirmButtonText: "Actualizar",
        cancelButtonText: "Cancelar",
        background: "#FFF7F0",
        preConfirm: () => ({
            cantidad: parseInt(document.getElementById("sw_cantidad").value),
            observacion: document.getElementById("sw_obs").value,
            recargo: parseFloat(document.getElementById("sw_recargo").value)
        })
    }).then(result => {

        if (!result.isConfirmed) return;

        fetch("{% url 'cajero_editar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(result.value)
        })
        .then(res => res.json())
        .then(data => {

            if (data.success) {
                document.getElementById("tabla_detalles").innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Detalle actualizado",
                    timer: 1200,
                    background: "#FFF7F0",
                    showConfirmButton: false,
                    iconColor: "#3E7A3F"
                });
            }

        });

    });
}
</script>


<script>
// -------------------------------------------------------------
// Eliminar detalle
// -------------------------------------------------------------
function eliminarDetalleAjax(detalle_id) {

    Swal.fire({
        title: "¿Eliminar producto?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
        background: "#FFF7F0",
        confirmButtonColor: "#C14949",
        cancelButtonColor: '#4F6D7A',
    }).then(result => {

        if (!result.isConfirmed) return;

        fetch("{% url 'cajero_eliminar_detalle_ajax' 0 %}".replace("0", detalle_id), {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(data => {

            if (data.success) {
                document.getElementById("tabla_detalles").innerHTML = data.tabla;

                Swal.fire({
                    icon: "success",
                    title: "Eliminado",
                    timer: 1200,
                    showConfirmButton: false,
                    background: "#FFF7F0",
                    iconColor: "#3E7A3F"
                });
            }
        });

    });
}
</script>


<script>
// -------------------------------------------------------------
// Enviar formulario principal
// -------------------------------------------------------------
document.getElementById("frm_editar_pedido").addEventListener("submit", function(e) {
    e.preventDefault();

    let formData = new FormData(this);

    fetch("", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {

        if (data.success) {

            Swal.fire({
                icon: "success",
                title: "Pedido actualizado correctamente",
                text: "Redirigiendo...",
                timer: 1500,
                showConfirmButton: false,
                background: "#FFF7F0",
                iconColor: "#3E7A3F"
            });

            setTimeout(() => {
                window.location.href = "{% url 'cajero_ver_pedido' 99999 %}".replace("99999", data.pedido_id);
            }, 1500);


        } else {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: data.mensaje,
                background: "#FFF7F0",
            });
        }

    });
});
</script>

<br>
{% endblock %}
