{% extends 'cajero/plantilla.html' %}
{% load static %}

{% block contenido %}

<br><br><br>

<div class="container mt-5">
    <h2 class="text-center text-primary mb-4">Notificaciones del Cajero</h2>

    <!-- Sección PEDIDOS LISTOS -->
    <h4 class="text-success mt-4">Pedidos listos</h4>
    <div id="noti-pedidos" class="mt-3"></div>

    <!-- Sección MENSAJES -->
    <h4 class="text-primary mt-5">Mensajes del cocinero</h4>
    <div id="noti-mensajes" class="mt-3"></div>
</div>

<style>
.alert {
    border-radius: 15px;
    box-shadow: 0 3px 10px rgba(0,0,0,.1);
}
</style>


<!-- ======================================================= -->
<!--               SISTEMA AJAX PARA RECARGA MANUAL           -->
<!-- ======================================================= -->

<script>
function cargarNotificaciones() {
    fetch("/notificaciones/obtener/")
    .then(r => r.json())
    .then(lista => {

        const pedidos = document.getElementById("noti-pedidos");
        const mensajes = document.getElementById("noti-mensajes");

        pedidos.innerHTML = "";
        mensajes.innerHTML = "";

        lista.forEach(n => {

            // PEDIDO LISTO
            if (n.tipo === "pedido_listo") {
                pedidos.innerHTML += `
                    <div class="alert alert-success mt-3 d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Pedido #${n.pedido} — Mesa ${n.mesa || ''}</strong><br>
                            ${n.mensaje}<br>
                            <small>${n.fecha}</small>
                        </div>

                        <button class="btn btn-sm btn-danger ms-3"
                                onclick="eliminarNotificacion(${n.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            }

            // MENSAJE
            if (n.tipo === "mensaje") {
                mensajes.innerHTML += `
                    <div class="alert alert-info mt-3 d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Mensaje del cocinero:</strong><br>
                            ${n.mensaje}<br>
                            <small>${n.fecha}</small>
                        </div>

                        <button class="btn btn-sm btn-danger ms-3"
                                onclick="eliminarNotificacion(${n.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            }
        });
    });
}

setInterval(cargarNotificaciones, 7000); // respaldo cada 7s
window.onload = cargarNotificaciones;


function eliminarNotificacion(id) {
    fetch(`/notificaciones/eliminar/${id}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cargarNotificaciones();
        }
    });
}
</script>


<!-- ======================================================= -->
<!--        SISTEMA WEBSOCKET PARA NOTIFICACIONES LIVE        -->
<!-- ======================================================= -->

<script>
    // ID del usuario cajero
    const USER_ID = "{{ request.user.id }}";

    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";

    const socketNotif = new WebSocket(
        ws_scheme + '://' + window.location.host + '/ws/notificaciones/' + USER_ID + '/'
    );

    socketNotif.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("WS recibido:", data);

        // PEDIDO LISTO LIVE
        if (data.tipo === "pedido_listo") {

            Swal.fire({
                icon: "success",
                title: "Pedido listo",
                html: `<b>Pedido #${data.pedido}</b><br>Mesa ${data.mesa ?? ''}`,
                confirmButtonColor: "#28a745"
            });

            cargarNotificaciones(); // actualiza sin esperar 7s
            return;
        }

        // MENSAJE DEL COCINERO LIVE
        if (data.tipo === "mensaje") {

            Swal.fire({
                icon: "info",
                title: "Nuevo mensaje del cocinero",
                text: data.mensaje,
                confirmButtonColor: "#3085d6"
            });

            cargarNotificaciones();
            return;
        }
    };

    socketNotif.onopen = function() {
        console.log("WS conectado para usuario:", USER_ID);
    };
</script>

{% endblock %}
